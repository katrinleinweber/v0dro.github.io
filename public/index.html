
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Travel &lt;code&gt; Music</title>
  <meta name="author" content="Sameer Deshmukh">

  
  <meta name="description" content="In this post I will document certain things I’ve learned when working with numpy.
Might be interesting to some people. Table of Contents Axes in &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://v0dro.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Travel &lt;code&gt; Music" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-55005305-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [ ['$', '$'], ["\(", "\)"] ],
        displayMath: [ ['$$', '$$'], ["\[", "\]"] ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
      //,
      //displayAlign: "left",
      //displayIndent: "2em"
    });
  </script>
  <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Travel &lt;code&gt; Music</a></h1>
  
    <h2>A place where I share my experiences with Travel, Programming and Music</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="v0dro.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/archives">Archive</a></li>
  <li><a href="/travel">Travel</a></li>
  <li><a href="/code">Code</a></li>
  <li><a href="/music">Music</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/07/notes-using-numpy/">Notes Using Numpy</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post I will document certain things I’ve learned when working with numpy.
Might be interesting to some people.</p>

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-generate-toc again -->
<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="#axes-in-numpy">Axes in numpy</a></li>
  <li><a href="#printoptions">Printoptions</a></li>
  <li><a href="#debugging">Debugging</a></li>
  <li><a href="#useful-functions">Useful functions</a>
    <ul>
      <li><a href="#setting-diagonals">Setting diagonals</a></li>
    </ul>
  </li>
  <li><a href="#resources">Resources</a></li>
</ul>

<!-- markdown-toc end -->

<h1 id="axes-in-numpy">Axes in numpy</h1>

<p>Axes in numpy are defined for arrays in more than one dim. A 2D array has the 0th axis running
vertically <em>downwards</em> across rows and the 1st axis is running <em>horizontally</em> running across
columns.</p>

<p>See https://docs.scipy.org/doc/numpy-1.10.0/glossary.html</p>

<h1 id="printoptions">Printoptions</h1>

<p>The <code>numpy.printoptions</code> function can be used for setting various global print options like
linewidth and precision during printing to console. Useful for debugging and viewing:</p>
<ul>
  <li><code>suppress</code> - Suppress printing in scientific notation.</li>
  <li><code>precision</code> - Limit the precision of numbers printed.</li>
  <li><code>linewidth</code> - Max width of printing.</li>
</ul>

<h1 id="debugging">Debugging</h1>

<p>The <code>pdb</code> module is useful for debugging python. Place <code>pdb.set_trace()</code> in some place
in the code where you want the code to break. It will then provide you with a python
REPL.</p>

<p>Here’s a link to it: https://pythonconquerstheuniverse.wordpress.com/2009/09/10/debugging-in-python/</p>

<h1 id="broadcasting">Broadcasting</h1>

<p>Numpy uses ‘broadcastable’ data structures. It describes how numpy treats arrays with
different shapes during arithmetic operations.</p>

<p>Link:</p>
<ul>
  <li>https://docs.scipy.org/doc/numpy/user/basics.broadcasting.html</li>
  <li>https://eli.thegreenplace.net/2015/broadcasting-arrays-in-numpy/</li>
</ul>

<h1 id="shape-parameters">Shape parameters</h1>

<p>Sometimes, some operations return their shape at <code>(R,1)</code> and some as <code>(R,)</code>. This design
decision is taken because numpy arrays are indexed by two numbers in the former case and
a single number in the latter case. This allows single number indexing and storage in
flat-indexed arrays.</p>

<p>Link: https://stackoverflow.com/questions/22053050/difference-between-numpy-array-shape-r-1-and-r/22074424</p>

<h1 id="useful-functions">Useful functions</h1>

<h2 id="setting-diagonals">Setting diagonals</h2>

<p>Use <code>numpy.fill_diagonal()</code> for filling the diagonal of an array with some number.
Take note that this is an in-place modification function and that it does not return
any value.</p>

<p>Link: https://docs.scipy.org/doc/numpy/reference/generated/numpy.fill_diagonal.html</p>

<h2 id="matrix-lower-triangle">Matrix lower triangle</h2>

<p>Use <code>numpy.tril()</code> and pass the object.</p>

<h2 id="inverse-of-a-matrix">Inverse of a matrix</h2>

<p>Compute multiplicative inverse of a matrix using <code>numpy.linalg.inv()</code>.</p>

<p>Link: https://docs.scipy.org/doc/numpy-1.14.0/reference/generated/numpy.linalg.inv.html</p>

<h2 id="multiplication">Multiplication</h2>

<p><code>*</code> is element-wise multiplication between two arrays. For matrix multiplication use
<code>numpy.matmul</code>.</p>

<h1 id="resources">Resources</h1>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/05/01/remote-file-editing-with-emacs/">Remote File Editing With Emacs.</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>I’m logging into various computers to harness their superior hardware which my
laptop can never support. In this post I’m documenting the stuff that should
be done for accessing remote files using emacs via your local machine.</p>

<h1 id="tramp">TRAMP</h1>

<p>TRAMP is an emacs utility that lets you edit remote files just like they’re local
files. In order to access a remote file, you need to use the following syntax
after doing a <code>C-x C-f</code>:</p>
<pre><code>/method:user@host:/path/to/file. 
</code></pre>
<p>In my case, I have the hosts written down in an ssh config file, so I can access a
file on computer <code>a2</code> in the following manner:</p>
<pre><code>/ssh:a2:/home/sameer/a.cpp
</code></pre>
<p>This is so incredibly intuitive and simple!</p>

<h1 id="note-about-fancy-shells">Note about fancy shells</h1>

<p>If you’re using some kind of fancy shell on your remote machine, it might cause tramp
to hang when accessing the machine via <code>C-x C-f</code>. For example, I was using oh-my-zsh
on a machine and tramp refused to work as a result. It started working fine after
reverting to bash.</p>

<p>Here’s a <a href="https://stackoverflow.com/questions/6954479/emacs-tramp-doesnt-work">resource</a> elaborating on that.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/05/01/building-a-fast-matrix-multiplication-algorithm/">Building a FAST Matrix Multiplication Algorithm.</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>I’ve received an assignment for writing a very fast matrix multiplication code using
multithreading, BLISLAB, SIMD, etc. In this post I will document my approach to writing
this code. I’ve made the best effort to optimize the multiplication to the hilt, but if
readers find anything amiss please leave a comment and I’ll have a look at it ASAP.</p>

<p>I’ve written various benchmarks and machines that the codes were tested on.</p>

<h1 id="testing-machine">Testing machine</h1>

<p>A Xeon server with the following specs was used for this assignment:</p>

<p>Final output of <code>cat /proc/cpuinfo</code></p>
<pre><code>processor	: 15
vendor_id	: GenuineIntel
cpu family	: 6
model		: 79
model name	: Intel(R) Xeon(R) CPU E5-2637 v4 @ 3.50GHz
stepping	: 1
microcode	: 0xb000021
cpu MHz		: 2807.360
cache size	: 15360 KB
physical id	: 1
siblings	: 8
core id		: 3
cpu cores	: 4
apicid		: 23
initial apicid	: 23
fpu		: yes
fpu_exception	: yes
cpuid level	: 20
wp		: yes
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer xsave avx f16c rdrand lahf_lm abm 3dnowprefetch ida arat epb invpcid_single pln pts dtherm intel_pt kaiser tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm rdseed adx smap xsaveopt cqm_llc cqm_occup_llc
bugs		:
bogomips	: 7002.86
clflush size	: 64
cache_alignment	: 64
address sizes	: 46 bits physical, 48 bits virtual
power management:
</code></pre>

<p>Top output of <code>cat /proc/meminfo</code>:</p>
<pre><code>MemTotal:       65598536 kB
MemFree:        44152804 kB
MemAvailable:   55485324 kB
Buffers:              80 kB
Cached:         15153880 kB
SwapCached:         4144 kB
</code></pre>

<p>The CPU details for this chip can be found here: https://en.wikichip.org/wiki/intel/xeon_e5/e5-2637_v4</p>

<p>The cache values for this processor are as follows:</p>
<ul>
  <li>L1 cache - 32 KB per chip per core (x4).</li>
  <li>L2 cache - 256 KB per chip per core (x4).</li>
  <li>L3 cache - 10 MB per chip per chip (shared).</li>
</ul>

<h1 id="matrix-parameters">Matrix parameters</h1>

<p>For this experiment, I’m using a 1000x1000 matrix of doubles, each matrix generated 
using a simple function <code>i*j + N</code>.</p>

<h1 id="the-initial-code">The initial code</h1>

<p>I started off with a basic O(N^3) multiplication algorithm that looks like this:</p>
<div class="language-cpp highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> i=<span style="color:#00D">0</span>; i&lt;N; i++) {
  <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> j=<span style="color:#00D">0</span>; j&lt;N; j++) {
    <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> k=<span style="color:#00D">0</span>; k&lt;N; k++) {
      C[i*N + j] += A[i*N + k] * B[k*N + j];
    }
  }
}
</pre></td>
</tr></table>
</div>

<p>This produced the following results:</p>
<pre><code>N = 1000. time: 4.53809 s. Gflops: 0.440714
</code></pre>
<p>Very slow indeed. Lets begin some optimization.</p>

<h1 id="loop-interchange">Loop interchange</h1>

<p>It so happens that when we write a simple 3-level loop for matmul where the result is obtained
one element at a time, we need to access the elements in a manner that does not produce the
same stride and is not therefore easily vectorizable. If the loops are interchanged they
will all become stride-1.</p>

<p>The new loop structure would look like this:</p>
<pre><code>for i = 0:N
  for k = 0:N
    for j = 0:N
      C(i,j) = A(i,k)*B(k,j)
</code></pre>
<p>This simple optimization gives somewhat faster results:</p>
<pre><code>N = 1000. time: 3.29635 s. Gflops: 0.606731
</code></pre>

<p>This mainly happens because now most elements are accessed in order of memory and there are
less cache misses. The cache loading/unloading is done by the OS and compiler until this
step and we have not intervened with these things at all.</p>

<p>Here’s the loop in code with comments as to movement of the pointer:</p>
<div class="language-cpp highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
</pre></td>
  <td class="code"><pre><span style="color:#777">// corresponds to rowwise movement of C (slowest). Indicates</span>
<span style="color:#777">// that one panel (horizontal) of C is populated at one time.</span>
<span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; N; i += NR) {
  <span style="color:#777">// corresponds to column of A. Moves with the rows of B.</span>
  <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> k = <span style="color:#00D">0</span>; k &lt; N; k += KC) {
    <span style="color:#777">// corresponds to the row of B. Moves with the columns of A.</span>
    <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> j = <span style="color:#00D">0</span>; j &lt; N; j += MC) {
      C[i*N + j] += A[i*N + k] * B[k*N + j];
    }
  }
}
</pre></td>
</tr></table>
</div>

<h1 id="loop-unrolling">Loop unrolling</h1>

<p>Slight modifications to the loops which involves unrolling some part of the loop and advancing
at a faster pace than one increment per loop iteration can reduce the overhead of updating the
variables associated with looping. Also, there is a special advantage to advancing the loop
counter by a factor of 4 (for double numbers). The data is brought into the cache line 64 bytes
at a time. This means that accessing data in chunks of 64 bytes reduces the cost of memory
movement between the memory layers.</p>

<p>After using a loop advacement of 5, the result improves to this:</p>
<pre><code>N = 1000. time: 2.04914 s. Gflops: 0.976018
</code></pre>

<p>The code for doing this looks like so:</p>
<pre><code>for (int i = 0; i &lt; N; i += NR) {
  for (int k = 0; k &lt; N; k += KC) {
    for (int j = 0; j &lt; N; j += MC) { // advance by block size
      //macro_kernel(A, B, C, i, j, k);
      A_ptr = A[i*N + k];
      B_ptr = &amp;B[k*N + j];
      C_ptr = &amp;C[i*N + j];
        
      *C_ptr += (*A_ptr)  * (*B_ptr);
      *(C_ptr+1) += (*A_ptr) * (*(B_ptr+1));
      *(C_ptr+2) += (*A_ptr) * (*(B_ptr+2));
      *(C_ptr+3) += (*A_ptr) * (*(B_ptr+3));
      *(C_ptr+4) += (*A_ptr) * (*(B_ptr+4));
    }
  }
}
</code></pre>

<h1 id="use-of-registers">Use of registers</h1>

<p>You can use the C++ <code>register</code> keyword when declaring a variable in order to suggest to the
compiler that the variable is supposed to stay in the register.</p>

<p>These variables are best used in cases where the variable needs to be used as an accumulator
for storing the repeating sum of some result.</p>

<p>For example, the macro kernel can be written this way:</p>
<pre><code>register double a0 = A(0,k), a1 = A(1,k), a2 = A(2,k), a3 = A(3,k);
  for (int j = 0; j &lt; N; j += 1) {
    C(0,j) += a0*B(k,j);
    C(1,j) += a1*B(k,j);
    C(2,j) += a2*B(k,j);
    C(3,j) += a3*B(k,j);
  }
</code></pre>
<p>This results in the following result:</p>
<pre><code>N = 1000. time: 2.2037 s. Gflops: 0.907564
</code></pre>

<h1 id="blocking">Blocking</h1>

<p>In general, it is helpful to compute the matrix in blocks rather than individually so that
we can take advantage of various vector operations and cache blocking. A simple blocking
technique would be to compute a block of 4x4 matrix at one time. For this purpose we can
use SSE instructions that allow computing multiplications of multiple numbers in parallel.</p>

<p>We first start off by trying to multiply the matrix in 4x4 blocks. This can be done by
modifying the loops</p>

<h2 id="aligned-memory-allocation">Aligned memory allocation</h2>

<p>The <code>posix_memalign</code> function allocates memory along a given alignment. Upon successful
completion, it returns a pointer value that is a multiple of the alignment variable. It
is helpful in cases where you want to use SIMD operations with a chunk of memory.</p>

<p>Source: http://pubs.opengroup.org/onlinepubs/009695399/functions/posix_memalign.html</p>

<h2 id="notes-on-blocking">Notes on blocking</h2>

<p>Q: If the numbers are stored in row major order anyway, what difference does it
make whether we use the packing order or the default row major order?
A: When multiplying the block of A with the panel of B, we proceed from left to
right of the panel. Due to this, the numbers of B get accessed in a stride and not in
sequentially. Packing would ensure that they are sequential.</p>

<h2 id="simd-instructions">SIMD instructions</h2>

<p>Intel introduced SIMD instructions in the their processors a while ago. These are now 
accessible via the AVX or SSE data types.</p>

<p>The AVX data types allow the use of 16 YMM registers. These can hold 4 x 64-bit double
numbers or 8 x 32-bit floats.</p>

<p>On the intel Broadwell CPU, there is support for AVX2 and SSE3 instruction sets. According
to intel, AVX is a natural progression of SSE.</p>

<h3 id="notes-on-simd">Notes on SIMD</h3>

<p>SIMD is mainly expressed using two kinds of instructions: SSE and AVX. AVX works with a
kind of register called <code>YMM</code> registers. AVX uses 16 such registers. Each YMM register
contains 4 64-bit double-precision floating point numbers.</p>

<p>In order to use these instructions, you need to include the <code>xmmintrin.h</code> header file into
your code. Data that is to be used using SIMD needs to be packed using the <code>__m256d</code> if
using the YMM registers useful for AVX instructions.</p>

<h3 id="simd-with-gcc">SIMD with gcc</h3>

<p>GCC -O0 is no optimization at all and when using with SIMD uses up about 7-8 instructions
per load of YMM registers.</p>

<p>GCC -O3 optimizations create some blazingly fast and highly optmized SIMD code. In this
section I will document some of the low level instructions that are used by SIMD
and which can be directly used from C++ code in order to produce highly optimized
matrix multiplication.</p>

<h4 id="gcc-inline-assembly">GCC inline assembly</h4>

<p>There’s two kinds of inline assembly - intel assembly and AT&amp;T assembly. GCC uses AT&amp;T
and all examples below will stick with that convention. It is important to note that
AT&amp;T assembly has the source operand as the first operand of the instruction and the
destination as the second operand.</p>

<p>All instructions must end with a <code>\n\t</code> for breaking the line and moving to the next
instruction field.</p>

<p>Link : https://www.codeproject.com/Articles/15971/Using-Inline-Assembly-in-C-C</p>

<h4 id="gcc-extended-assembly">GCC extended assembly</h4>

<p>GCC has a special extended assembly instruction syntax that allows you to freely pass
C variables to and from assembly code. It allows you to specify variables and use
them within the assembly instructions.</p>

<p>It has the following format:</p>
<pre><code>asm [volatile] ( AssemblerTemplate 
                 : OutputOperands 
                 [ : InputOperands
                 [ : Clobbers ] ])
</code></pre>
<p>This allows you to specify an ‘assembler template’ inside which you can specify the
kind of assembly instructions that you want along with a template for input and output
operands. The compiler will read this template along with the specified parameters
and replace the parameters in the template before outputting the assembly code.</p>

<p>The output and input operands have to specified in a given format for correct processing:</p>
<pre><code>[ [asmSymbolicName] ] constraint (cvariablename)
</code></pre>
<p>The first <code>[ [asmSymbolicName] ]</code> is usually expressed in the assembler template. The
<code>constraint</code> is a literal string that specifies certain constraints on the placement of 
the operand. Output constraints <em>must</em> begin with either <code>=</code> (a variable overwriting an
existing value) or <code>+</code> (when reading and writing). After this prefix, specify another
constraint where the value resides. Use <code>r</code> for register and <code>m</code> for memory or <code>rm</code> for
register or memory (compiler will choose).</p>

<p>After specifying input and output variables, if your asm modifies any of the system
registers as a side effect, they should be specified in the <code>Clobbers</code> field.</p>

<p>Link : https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html</p>

<h4 id="register-naming-and-conventions">Register naming and conventions</h4>

<p>Registers names being with a <code>%</code>. So register <code>rdx</code> is named as <code>%rdx</code>. The special purpose
ymm registers are used with a suffix of the number of the register. So you can refer to the
3rd YMM register using <code>%ymm3</code>.</p>

<h4 id="immediate-operands">Immediate operands</h4>

<p>Immediate operands (or literals) are marked using a <code>$</code>. So to add <code>5</code>, register 
<code>eax</code> would be <code>add $5, %eax</code>.</p>

<h4 id="indexing">Indexing</h4>

<p>Indexing or indirection is done by enclosing the index register or indirection 
memory cell address in parentheses. For example <code>mov %edx, (%eax)</code> will move the
data pointed to by <code>%eax</code> to <code>%edx</code>. Specifying a number before the bracket will</p>

<h4 id="mov-instructions">mov instructions</h4>

<p><code>movq</code> is used for moving 64-bit words from source to destination and <code>movl</code> is used for 32-bit.</p>

<p>Link : https://www.quora.com/What-is-the-difference-between-movq-and-movl-assembly-instruction</p>

<h4 id="instruction-vmovapd">Instruction vmovapd</h4>

<p>This is the assembly equivalent of <code>_mm256_load_pd(double*)</code>. It accepts two instructions,
source (second operand) and destination (first operand).</p>

<p>Link : https://www.felixcloutier.com/x86/MOVAPD.htmlx</p>

<p>A sample <code>vmovapd</code> from gcc looks like <code>vmovapd	(%rdx), %ymm13</code>. This is assigning
the contents in the pointer</p>

<h4 id="instruction-vbroadcastsd">Instruction vbroadcastsd</h4>

<p>Broadcasts a value kept at a pointer to a YMM register.</p>

<h4 id="instruction-vfmadd231pd">Instruction vfmadd231pd</h4>

<p>Performs a set of SIMD multiply-add computation on packed double-precision 
floating-point values using three source operands and writes the multiply-add
results in the destination operand. The destination operand is also the first
source operand. The second operand must be a SIMD register. The third source
operand can be a SIMD register or a memory location.</p>

<p>Link : https://www.felixcloutier.com/x86/VFMADD132PD:VFMADD213PD:VFMADD231PD.html</p>

<h1 id="packing-data-into-caches">Packing data into caches</h1>

<p>According to the GotoBLAS (and later BLIS) approach, it is necessary to pack the panels of 
A and B in such a way that the data within is sequentially accessible. This requires some
reconstruction of each mini-panel before performing the actual computation.</p>

<p>The BLISlab framework uses a novel approach for this purpose. It first stores the pointers
of all the elements that need to be copied into a new array using an array to pointers of 
doubles. It then simply dereferences these pointers and copies them into the packed array.</p>

<p>Here’s some C code that makes this happen:</p>

<div class="language-cpp highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
</pre></td>
  <td class="code"><pre><span style="color:#0a8;font-weight:bold">int</span> p; 
<span style="color:#0a8;font-weight:bold">double</span> *b_pntr[ SIZE ]; <span style="color:#777">// create array of pointers of doubles.</span>

<span style="color:#777">// ... code that copies pointers of packed array to b_pntr</span>

<span style="color:#777">// deference b_pntr and copy data one by one to packB</span>
<span style="color:#080;font-weight:bold">for</span> (p = <span style="color:#00D">0</span>; p &lt; SIZE; p++) {
  *packB++ = *b_pntr[ p ] ++;
}
</pre></td>
</tr></table>
</div>

<h1 id="using-pointers">Using pointers</h1>

<p>When you call something like <code>C[i*N + j]</code> for getting the value in memory of an element in C,
you are wasting time in calculating the address of the element in C where it resides. Instead,
you directly use pointers to advance the pointer value in memory rather than such explicit
calculation.</p>

<p>For example, to set the value of all elements of an array C to 0:</p>
<pre><code>double *cp;
for ( j = 0; j &lt; n; j ++ ) { 
  cp = &amp;C[ j * ldc ];
  for ( i = 0; i &lt; m; i ++ ) { 
    *cp++ = 0.0;
  }
}
</code></pre>

<p>After using pointers in the matrix multplication, it looks like this:</p>
<pre><code>N = 1000. time: 1.71545 s. Gflops: 1.16587
</code></pre>

<h1 id="multithreading-optimization">Multithreading optimization</h1>

<p>Using the <code>for</code> loop openmp threading directive led to a pretty massive speedup. Here’s the
results with a <code>#pragma openmp parallel for</code> for the above stride-oriented code:</p>
<pre><code>N = 1000. time: 0.815704 s. Gflops: 2.45187
</code></pre>
<p>This is faster than gemm! Wonder what does dgemm do internally that causes it to not
fully exploit the resources of the CPU.</p>

<p>How exactly does the omp for loop parallelization work?</p>

<p>Using pointers with the above implementation produces the following result:</p>

<h1 id="blislab">BLISlab</h1>

<p>BLISlab provides a framework for efficiently implementing your own version of BLAS. This is
particularly handy for people who want to implement a BLAS of their own on any machine.</p>

<h2 id="blislab-notes">BLISlab notes</h2>

<p>In original BLISlab framework it is important to remember that the A matrix is stored
in row-major and B in column-major.</p>

<h1 id="results-on-tsubame">Results on TSUBAME</h1>

<h2 id="notes-on-tsubame">Notes on TSUBAME</h2>

<p>The TSUBAME users guide can be found <a href="http://www.t3.gsic.titech.ac.jp/docs/TSUBAME3.0_Users_Guide_en.html">here</a>.</p>

<p>The <code>qsub</code> command is used for submitting a jobs. A ‘job script’ is used for this
purpose. A sample job script looks like so:</p>
<pre><code>#!/bin/sh
#$ -cwd
#$ -l f_node=1
#$ -l h_rt=0:02:00
./a.out 1024
</code></pre>
<p>In the above program the lines that begin with <code>#$</code> specify various parameters that specify
the kind of node and number of such nodes (<code>f_node</code> in this case) and the time for which 
we want to reserve the node (2 min in the above case). At the end of the file we specify
the executable name and the parameters that are to be passed to it.</p>

<p>You can check the status of your job with the <code>qstat</code> command. A sample execution looks like so:</p>
<pre><code>17M38101@login0:~/&gt; qstat
job-ID     prior   name       user         state submit/start at     queue                          jclass                         slots ja-task-ID 
------------------------------------------------------------------------------------------------------------------------------------------------
   2627115 0.00000 job.sh     17M38101     qw    06/10/2018 18:23:45  
</code></pre>

<p>Once the job is done, it will deposit the error and output in separate files in your pwd.</p>

<p>You can use <code>qdel &lt;task_id&gt;</code> for deleting a submitted job.</p>

<h2 id="debugging-using-tsubame-tools">Debugging using TSUBAME tools</h2>

<p>Tools like Allinea DDT can be used from TSUBAME for debugging parallel applications.</p>

<p>For this purpose you need to switch on X window forwarding in your login session and
start an interactive session on TSUBAME. When you ssh into TSUBAME you should also
login using the <code>-Y</code> option.</p>

<p>To test if X forwarding works, use a command like <code>xterm</code> and see if its opens a window
locally. You can use Allinea DDT for parallel debugging.</p>

<p>After compiling, you can execute the binary using <code>ddt a.out</code> command.</p>

<p>Link:</p>
<ul>
  <li>https://kb.iu.edu/d/bdnt</li>
  <li>https://computing.llnl.gov/tutorials/allineaDDT/Examples.pdf</li>
</ul>

<h2 id="cpu-information-on-f-node">CPU information on f-node</h2>

<p>On an f-node of TSUBAME, the CPU information is as follows:</p>
<pre><code>processor	: 55
vendor_id	: GenuineIntel
cpu family	: 6
model		: 79
model name	: Intel(R) Xeon(R) CPU E5-2680 v4 @ 2.40GHz
stepping	: 1
microcode	: 0xb00001f
cpu MHz		: 2899.022
cache size	: 35840 KB
physical id	: 1
siblings	: 28
core id		: 14
cpu cores	: 14
apicid		: 61
initial apicid	: 61
fpu		: yes
fpu_exception	: yes
cpuid level	: 20
wp		: yes
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch ida arat epb invpcid_single pln pts dtherm intel_pt kaiser tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm rdseed adx smap xsaveopt cqm_llc cqm_occup_llc
bugs		:
bogomips	: 4801.76
clflush size	: 64
cache_alignment	: 64
address sizes	: 46 bits physical, 48 bits virtual
power management:
</code></pre>
<p>More detailed information about the processor can be found <a href="http://www.spec.org/cpu2006/results/res2016q3/cpu2006-20160725-43026.pdfx">here</a>.</p>

<p>The cache levels are as follows:</p>
<ul>
  <li>L1 cache - 32 kb per chip per core.</li>
  <li>L2 cache - 256 kb per chip per core.</li>
  <li>L3 cache - 35 MB per chip per chip.</li>
</ul>

<h1 id="notes-on-computer-architecture">Notes on computer architecture</h1>

<h2 id="cache-access">Cache access</h2>

<p>When the processor requests a particular chunk of memory, it is first copied into the cache
from the main memory (assuming that the cache is ‘empty’ for now). The closer the data is
from the processor, the fewer clock cycles it needs to wait for performing instructions. Every
time during a memory access, the processor first checks the cache for the data, and in case
the data is not present it will fetch the data from the memory. This is called a cache miss.
Data is copied into cache from the memory every time a cache miss occurs. It is assumed that 
data that is adjacent to data that is being used has a high probability of being accessed. This
is called spatial locality. Cache misses are handled by hardware.</p>

<p>The <em>miss rate</em> is simply the component of cache accesses that result in a miss. When the
processor fetches data from the memory into the cache, it will fetch a fixed-size <em>block</em>
or <em>line run</em> chunk of data that contains the requested data.</p>

<h2 id="cache-hierarchies">Cache hierarchies</h2>

<p>Caches are typically L1, L2 and L3. L1 being closest to the CPU (and least capacity) and L3
being farthest (most capacity).</p>

<h2 id="my-processor-config">My processor config</h2>

<p>I’m using the TSUBAME login node which has a <a href="https://en.wikichip.org/wiki/intel/xeon_e5/e5-2637_v4">Intel(R) Xeon(R) CPU E5-2637 v4</a> processor.
The L1 and L2 caches are per-core whereas the L3 cache is shared.
The wikichip page says it has the following cache config:
*</p>

<h1 id="papers">Papers</h1>

<ul>
  <li>BLISlab paper: sandbox for optimizing BLAS.</li>
  <li>Anatomy of high performance matrix multiplication.</li>
  <li>Anatomy of high-performance many-threaded matrix multiplication.</li>
</ul>

<h2 id="brief-paper-summaries">Brief paper summaries</h2>

<h3 id="anatomy-of-high-performance-matrix-multiplication">Anatomy of high performance matrix multiplication</h3>

<p>This paper describes what is currently accepted as the most effective approach,
to implementation, also known as the GotoBLAS approach.</p>

<h1 id="resources">Resources</h1>

<ul>
  <li>http://jguillaumes.dyndns.org/doc_intel/f_ug/vect_int.htm</li>
  <li><a href="https://stackoverflow.com/questions/25475186/sgemm-does-not-multithread-when-dgemm-does-intel-mkl">sgemm does not multithread sometimes.</a></li>
  <li><a href="http://www.catb.org/esr/structure-packing/">Structure packing in C.</a></li>
  <li><a href="https://software.intel.com/en-us/articles/intel-xeon-phi-processor-7200-family-memory-management-optimizations">Intel 7200 family memory management.</a></li>
  <li><a href="https://github.com/flame/how-to-optimize-gemm/wiki">gemm optimization</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions">Advanced Vector Instructions (AVX)</a></li>
  <li><a href="https://www.polyhedron.com/web_images/intel/productbriefs/3a_SIMD.pdf">The significance of SSE and AVX.</a></li>
  <li><a href="https://www.codeproject.com/Articles/874396/Crunching-Numbers-with-AVX-and-AVX">Crunching numbers with AVX2</a></li>
  <li><a href="https://austingwalters.com/the-cache-and-multithreading/">Cache and multithreading</a></li>
</ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/20/emacs-org-mode-notes/">Emacs Org-mode Notes</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>Note taking is getting quite tedious these days with just markdown and written notes,
so I started using org-mode, which is supposed to be very good. The results so far have
been fabulous. In this post I will docuement the things that I learned about org-mode
and will update the post as and when I find out new things.</p>

<h1 id="expand-and-collapse-headers">Expand and collapse headers</h1>

<p>Headers are written with <code>*</code>. More <code>*</code>’s you add more the level of indentation. Going to
a header title and pressing TAB will collapse or expand the contents of the header.</p>

<h1 id="tagging-and-searching">Tagging and searching</h1>

<p>Link: https://orgmode.org/worg/org-tutorials/advanced-searching.html</p>

<p>Org mode has some powerful search features that allow you to tag certain headers with
certain tags that allow you to search headers by tag. The tag has the syntax <code>:&lt;tag_name&gt;:</code>
after a header. So if you want a header <code>foo</code> as <code>bar</code> you can do:</p>
<pre><code>* foo :bar:
</code></pre>

<h1 id="writing-presentations">Writing presentations</h1>

<p>Link: https://orgmode.org/worg/exporters/beamer/tutorial.html</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/20/bash-scripting-to-automate-porting-to-other-machines/">Bash Scripting to Automate Porting to Other Machines</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>I need to log into multiple machines every now and then and its really annoying to
set everything up from scratch. Here’s some simple things I did with bash scripting
for automating most of my workflow.</p>

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="#bash-basics">Bash basics</a>
    <ul>
      <li><a href="#if-statements">If statements</a></li>
    </ul>
  </li>
  <li><a href="#scripting-protips">Scripting protips</a>
    <ul>
      <li><a href="#checking-env-variables">Checking env variables</a></li>
      <li><a href="#checking-for-programs">Checking for programs</a></li>
    </ul>
  </li>
  <li><a href="#resources">Resources</a></li>
</ul>

<!-- markdown-toc end -->

<h1 id="bash-basics">Bash basics</h1>

<p>A bash must have the line <code>#!/bin/bash</code> on the 1st line to let the OS know that this
is a bash script.</p>

<h2 id="if-statements">If statements</h2>

<p>You can check for existence of environment variables and execute specfic things. To
check whether a env variable exists, following syntax can be used:</p>

<p>If statements have the basic syntax:</p>
<pre><code>if [ &lt;some test&gt; ]; then
  &lt;commands&gt;
elif [ &lt;some test&gt; ]; then
  &lt;commands&gt;
else
  &lt;commands&gt;
fi
</code></pre>
<p>The square brackets in the above <code>if</code> statement are actually a reference to the command
<code>test</code>. This means that all operators that <code>test</code> allows may be used here as well. See
<code>man test</code> to the see capabilities of the <code>test</code> command.</p>

<h1 id="scripting-protips">Scripting protips</h1>

<h2 id="checking-env-variables">Checking env variables</h2>

<p>You can just check whether env variables exist or not with <code>if $VAR_NAME</code>. You need to
specify a call to <code>test</code> inside square brackets and specify <code>-z</code> if you want to check
whether the variables does not exist and <code>-n</code> if you want to check if the variable
exists.</p>

<p>For example, cheking if <code>$SERVER_ENV</code> variable exists or not will look like this:</p>
<pre><code>if [-n "$SERVER_ENV"]; then
    echo "SERVER_ENV exists"
fi
</code></pre>
<h2 id="checking-for-programs">Checking for programs</h2>

<p>If you want to check whether a particular program exists or not, use <code>hash &lt;command_name&gt;</code>.</p>

<p>For example, to see if git exists and print an error if not:</p>
<pre><code>if ! hash git 2&gt;/dev/null; then
    echo "Please install git before proceeding."
    exit 1
fi
</code></pre>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="https://stackoverflow.com/questions/592620/check-if-a-program-exists-from-a-bash-script">Checking whether program exists.</a></li>
</ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/18/writing-snippets-for-yasnippet-in-emacs/">Writing Snippets for Yasnippet in Emacs</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>In order to make typing things easier I’ve been yasnippet with some custom snippets
of mine. The yasnippet devs have been kind enough to offer plenty of detailed tutorials
on how to write your own snippets. In this post I will highlight the steps that I took
to write some simple ones. For more detailed information you should of course read the
actual yasnippet docs.</p>

<h1 id="getting-started">Getting started</h1>

<p>Just invoke <code>M-x yas-new-snippet</code> to invoke a new buffer that opens in a major mode
called <code>snippet-mode</code>. This mode is created specifically for creating yasnippets and
is very useful for this purpose. The buffer that it opens will have a template for
writing a snippet. There are some lines at the beginning that start with <code>#</code>, these
lines are comments and are also used for specifying ‘properties’ of the snippet.</p>

<p>For example, here’s a header for a snippet that I wrote for expanding <code>@param</code> listing
in YARD documentation:</p>
<div class="language-snippet highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
</pre></td>
  <td class="code"><pre># -*- mode: snippet -*-
# name: Write @params attribute of YARD docs.
# key: param
# group: yard_docs
# contributor: Sameer Deshmukh (@v0dro)
# --
</pre></td>
</tr></table>
</div>

<p>In the above header, the <code>name:</code> attribute is a string describing the purpose of this
snippet. <code>key:</code> is an important attribute that describes the key that yasnippet will
lookout for when expanding a snippet. <code>group</code> specifies which group a snippet would
belong to when it is listed in the <code>yas-describe-tables</code> table (it has no other
purpose than grouping). The <code>contributor:</code> field is just used for writing the name
of the contributor.</p>

<h1 id="snippet-syntax">Snippet syntax</h1>

<p>Some tutorials say that the snippet syntax is similar to that of TextMate, but I’ve
never used TextMate so I have no idea. I’ll now describe in as much detail as is required
the yasnippet snippet syntax in this section.</p>

<p>The basic work-flow is that you write some text in the file along with some markup for specifying
places where you want the user to type things when they jump across the snippet (the thing
that happens when you keep pressing TAB after typing something after expanding the snippet).</p>

<p>Following is the text to specify an expansion for @param attribute in the <a href="">YARD syntax</a>:</p>
<pre><code># @param $1 [$2] $3
$0
</code></pre>
<p>In the above text, <code># @param</code> is the text that specifies that this is a Ruby comment and the
<code>@param</code> is a YARD directive that specifies that this is a param being defined. The <code>$</code> followed
by the number are the TAB stop fields. These will specify the first, second and third place in
the text that the cursor will go to after the user presses TAB. The <code>$0</code> has a special significance.
It is the ‘TAB stop field’. This will be the exit point of the snippet once the user is done
pressing TAB for the final time.</p>

<p>The above snippet can be further improved to provide default values for the TAB stop fields by
replacing it with the following syntax:</p>
<pre><code># @param ${1: arg name} [${2: data type}] ${3: description.}
$0
</code></pre>
<p>The <code>${N:description}</code> syntax can be used for providing default values.</p>

<h1 id="organizing-snippets">Organizing snippets</h1>

<p>Snippets are organized by sub-directories by the major-mode in which they belong.
For example:</p>
<pre><code>|-- c-mode
|   `-- printf
|-- java-mode
|   `-- println
`-- text-mode
    |-- email
    `-- time
</code></pre>
<p>By default, your personal snippets collection lives inside <code>~/.emacs.d/snippets</code>.</p>

<p>In order to save the snippet file, press <code>C-c C-c</code>. It will prompt your for entering the
folder where the snippet is to be saved. Keep the folder name as the major mode and the
file name as the key of the snippet.</p>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="https://joaotavora.github.io/yasnippet/snippet-development.html">Detailed tutorial on writing snippets.</a></li>
  <li><a href="https://joaotavora.github.io/yasnippet/snippet-organization.html">Organizing snippets.</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/14/setup-emacs-for-latex-editing/">Setup Emacs for LaTeX Editing</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>I’m writing this blog as I’m learning latex and setting up emacs to use it. Previously
I mainly use LyX for writing research papers but the lack of text leads to lesser
customization options sometimes, which is why I’ll be shifting to plain text LaTeX
henceforth.</p>

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="#latex-protips">Latex protips</a></li>
  <li><a href="#emacs-latex-setup">Emacs latex setup</a></li>
  <li><a href="#resources">Resources</a></li>
</ul>

<!-- markdown-toc end -->

<h1 id="latex-protips">Latex protips</h1>

<h2 id="structure-of-documents">Structure of documents</h2>

<p>Docs consist of preamble and main document. The preamble contains commands for telling latex
which packages you will use and what kind of document you want to setup.</p>

<p>A sample preamble looks like so:</p>
<pre><code>% Preamble
% ---
\documentclass{article}

% Packages
% ---
\usepackage{amsmath} % Advanced math typesetting
\usepackage[utf8]{inputenc} % Unicode support (Umlauts etc.)
\usepackage{hyperref} % Add a link to your document
\usepackage{graphicx} % Add pictures to your document
\usepackage{listings} % Source code formatting and highlighting
</code></pre>

<p>Only the <code>documentclass</code> command is mandatory. The rest are optional. <code>usepackage</code> cannot be
used inside the main document. When using the <code>article</code> documentclass, latex will add the page
numbers automatically to the bottom of each document.</p>

<p>The main document is contained inside the <code>document</code> environment like this:</p>
<pre><code>\begin{document}
% ...
% ... Text goes here
% ...
\end{document}
</code></pre>

<h2 id="environments">Environments</h2>

<p>Latex comes with many pre-defined environments which you can use for setting up your
documents with minimal work. They come with some useful defaults too. For example, to
write a new Design Thinking assignment, I wrote the following preamble:</p>
<div class="language-latex highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
</pre></td>
  <td class="code"><pre>\documentclass{article}
\title{Assignment 2: One hour observation}
\date{2018-4-22}
\author{Sameer Deshmukh}
</pre></td>
</tr></table>
</div>
<p>Then using the <code>\maketitle</code> command inside the document body will directly create the
title page for us.</p>

<h2 id="sections-and-paragraphs">Sections and paragraphs</h2>

<p>Add sections using <code>\section{Section-name}</code> and sub-sections using <code>\subsection{sub-sec-name}</code>.
You can add as many <code>sub</code>’s to the subsection in order to specify multiple subsections. Using
the <code>\paragraph{Name goes here}</code> command will add a paragraph to the section.</p>

<h2 id="adding-images">Adding images</h2>

<p>You need the <code>graphicx</code> package to use images in your documents. Then use the 
<code>\graphicspath{ {folder-name/} }</code> command to tell latex the directory in which the images
are stored w.r.t the current directory. These should be declared in the preamble.</p>

<p>You can then use the <code>\includegraphics{graphic-name}</code> command to show images in your
document wherever you want.</p>

<p>You can specify various parameters to <code>includegraphics</code> for working with the image like
height, width and scaling inside square brackets. For example:”</p>
<pre><code>\includegraphics[width=3cm, height=4cm]{image}
</code></pre>
<p>Just seeting width to <code>\textwidth</code> and leaving out height will keep the default height
and set the width to the width of the text in the document. Like this:</p>
<pre><code>\includegraphics[width=\textwidth]{image}
</code></pre>
<p>See the <a href="https://www.sharelatex.com/learn/Inserting_Images#Reference_guide">reference guide</a> for
a more detailed description of the lengths and units that can be specified.</p>

<h2 id="useful-commands">Useful commands</h2>

<ul>
  <li>New page - <code>\newpage</code>.</li>
  <li>Make a title page - <code>\maketitle</code>.</li>
</ul>

<h3 id="text-formatting">Text formatting</h3>

<p>Use <code>\textbf{text}</code> for bold text, <code>\underline{text}</code> for underlined text and
<code>\textit{text}</code> for italics.</p>

<h3 id="symbols">Symbols</h3>

<ul>
  <li>Empty set: <code>\emptyset</code> is a 0 with a back slash through it.</li>
  <li>Uptack or falsum: <code>\bot</code> looks like Japanese 上 but without the upper dash.</li>
  <li>Is a member of: <code>\in</code>, for denoting that something is a part of a set.</li>
  <li>Not equal to: <code>\neq</code>.</li>
  <li>Set union: <code>\cup</code></li>
</ul>

<h2 id="writing-algorithms">Writing algorithms</h2>

<h3 id="setup-of-environment">Setup of environment</h3>

<p>I’m using the <code>algorithmicx</code> package for writing algorithms. This package will be installed
with the <code>texlive-full</code> package on the Ubuntu repos. Put the following lines in the preamble
to use:</p>
<pre><code>\usepackage{algorithm}
\usepackage{algpseudocode}
</code></pre>
<p>This is because algorithmicx pacakage is just a bundle of style files with macros that build
on top of <code>algorithm</code> and <code>algorithmic</code>. It does not define a package of itself.</p>

<p>The algorithms should lie inside the <code>algorithm</code> environment. You can use <code>\caption</code> and
<code>\label</code> to define those properties respectively. For example:</p>
<pre><code>\begin{algorithm}
  \caption{Leader election in arbitrary graph}
  \label{leader_election}
\end{algorithm}
</code></pre>

<h3 id="writing-algorithms-1">Writing algorithms</h3>

<p>The actual algorithm should be written inside the <code>algorithmic</code> block. An optional numerical
argument can specify in how many lines do you want the lines to be numbered. Example:</p>
<pre><code>\begin{algorithmic}[1]
  \State \textbf{when} {START} \textbf{is received do}
\end{algorithmic}
</code></pre>

<h3 id="basic-commands-for-algorithms">Basic commands for algorithms</h3>

<p>Variables and program statements in general should be written inside <code>$</code> signs so that they
will be italicized. Here’s a list of basic commands for writing various tasks:</p>

<ul>
  <li><code>\gets</code>: Assignment using a left pointing arrow like <code>&lt;-</code>.</li>
  <li>For loop: <code>\For{&lt;condition&gt;} &lt;text&gt; \EndFor</code></li>
  <li>Comments: Use <code>\Comment</code> for comments.</li>
</ul>

<h2 id="checking-for-installed-latex-packages">Checking for installed latex packages</h2>

<p>Use the <code>kpsewhich</code> command to see if a package is installed (alongwith its path). Example:</p>
<pre><code>kpsewhich algorithm.sty 
</code></pre>

<h2 id="writing-custom-latex-commands">Writing custom latex commands</h2>

<p>If you want to create certain kinds of custom blocks or more crazy things, you can create
your own custom commands that make such tasks easier. Below is the code for a custom <code>When</code>
command that will insert a <code>When</code> block into the code for denoting certain events.</p>
<pre><code>\algrenewcommand\algorithmicindent{3.0em}
\algnewcommand{\IIf}[1]{\State\algorithmicif\ #1 \algorithmicthen}
\algnewcommand{\EndIIf}{\unskip\ \algorithmicend\ \algorithmicif}
\newcommand*\Let[2]{\State #1 $\gets$ #2}
\algdef{SN}[when]{When}{EndWhen}
[3][\null]{
  \ifthenelse{\equal{#1}{\null}}{
    \ifthenelse{\equal{#3}{}}{
      {\bf when} \Call{#2}{\null} {\bf is received do}
    }{
      {\bf when} \Call{#2}{#3} {\bf is received do}
    }
  }{
    \ifthenelse{\equal{#3}{}}{
      {\bf when} \Call{#2}{\null} {\bf is received from #1 do}
    }{
      {\bf when} \Call{#2}{#3} {\bf is received from #1 do}
    }
  }
}
\renewcommand{\thealgorithm}{}
</code></pre>

<h1 id="emacs-latex-setup">Emacs latex setup</h1>

<p>I mainly followed other blog posts to setup this one. First install texlive and auctex packages
from your package manager.</p>

<p>Then add the following to your emacs init file:</p>
<pre><code>;; setup auctex
(require `tex-site)
(require `tex-style)
(add-hook `LaTeX-mode-hook `turn-on-reftex)

;; spellcheck in LaTex mode
(add-hook `latex-mode-hook `flyspell-mode)
(add-hook `tex-mode-hook `flyspell-mode)
(add-hook `bibtex-mode-hook `flyspell-mode)

;; Math mode for LaTex
(add-hook 'LaTeX-mode-hook 'LaTeX-math-mode)
</code></pre>

<h2 id="auctex-protips">Auctex protips</h2>

<p>Using auctex for your document editing provides some powerful features for editing and previewing
documents. Here’s a list of what can be done:</p>
<ul>
  <li>Preview a section right inside the buffer: <code>C-c C-p C-d</code>.</li>
  <li>Preview the entire buffer: <code>C-c C-p C-b</code>.</li>
  <li>Compile into a PDF: <code>C-c C-c</code>.</li>
</ul>

<h2 id="preview-latex-symbols-within-emacs">Preview latex symbols within emacs</h2>

<h2 id="view-formatted-pdf">View formatted PDF</h2>

<p>The <code>docview-mode</code> can be used for previewing a PDF file from within emacs. This mode is bundled
with emacs 24. Put the line <code>(setq doc-view-continuous 1)</code> in your init file so that you can
scroll through PDFs seamlessly.</p>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="https://piotrkazmierczak.com/2010/emacs-as-the-ultimate-latex-editor/">Using auctex with emacs</a></li>
  <li><a href="http://hal.case.edu/~rrc/blog/2013/11/04/latex/">Latex, Auctex and emacs.</a></li>
  <li><a href="https://www.latex-tutorial.com">Latex tutorial.</a></li>
  <li><a href="https://piotrkazmierczak.com/2012/previewing-latex-symbols-without-preview-latex/">Preview Latex symbols without preview-latex.</a></li>
  <li><a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/DocView-Navigation.html">DocView navigation.</a></li>
  <li><a href="https://www.sharelatex.com/learn/Inserting_Images">Inserting images in latex.</a></li>
  <li><a href="http://tug.ctan.org/macros/latex/contrib/algorithmicx/algorithmicx.pdf">Algorithmicx package tutorial.</a></li>
  <li><a href="https://tex.stackexchange.com/questions/29429/how-to-use-algorithmicx-package">algorithmicx package with latex.</a></li>
  <li><a href="https://tex.stackexchange.com/questions/229355/algorithm-algorithmic-algorithmicx-algorithm2e-algpseudocode-confused">Comparison between various algorithm environments.</a></li>
  <li><a href="https://tex.stackexchange.com/questions/22798/nice-looking-empty-set">Nice looking empty set.</a></li>
</ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/12/notes-on-learning-scala-for-distributed-algorithms/">Notes on Learning Scala for Distributed Algorithms</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>I’m currently taking a college course on <a href="http://www.coord.c.titech.ac.jp/c/distribalgo/">distributed algorithms</a>, that uses scala for
teaching. I’m not familiar with distributed algorithms or scala, so in this blog I will
document my learnings and provide some protips on a simple scala setup.</p>

<h1 id="scala-setup">Scala setup</h1>

<p>We advised by the instructor so use scala using the intelliJ IDE, but since I’m
not a big fan of IDEs and prefer using my editor (emacs). I thought I get away
with simply installing scala from the command line (<code>apt-get install scala</code>)
and invoking my programs from the command line using the <code>scalac</code> or <code>scala</code>
programs.</p>

<p>The course requires using a dependency called <a href="URL">scalaneko</a>, which of course
needs to specified before building your program. I tried to compile this with
a simple Makefile that looked like this:</p>
<pre><code>run:
	scala -cp scalaneko_2.12-0.19.0-SNAPSHOT.jar hello_world.scala
</code></pre>

<p>Above Makefile simply tries to specify the classpath using the <code>-cp</code> flag and runs
the scala file. However, this approach fails with errors that probably are hinting
towards the dependency being compiled using a different version of scala.</p>

<p>Therefore, I decided to use SBT for this purpose. SBT is more complex tool for my
simple usage but I think the time saved in the long run would be worth it.</p>

<p>For installation, followed the setup guide <a href="">here</a>. I read the <a href="https://www.scala-sbt.org/1.x/docs/Getting-Started.html">getting started guide</a> to see how to make it work.
Here’s a brief description (make sure sbt is installed first):
First cd into the folder you want to setup your first project. Then execute:</p>
<pre><code>sbt new sbt/scala-seed.g8
</code></pre>
<p>Type a project name (say <code>hello</code>) when prompted for it. You then cd into the <code>hello</code>
directory and execute <code>sbt</code>. Once inside the prompt, type <code>run</code>. This whole process
takes a while to complete since it downloads and compiles many sources.</p>

<h1 id="scala-syntax-protips">Scala syntax protips</h1>

<h2 id="values-and-variables">Values and variables</h2>

<p>Scala supports values and variables. Values cannot be changed and are technically
constants (immutable). Values are declared with <code>val</code> and variables with <code>var</code>.</p>

<p>Since scala supports type inference you don’t need to explicitly declare the type
of your values or variables.</p>

<h2 id="for-loop">For loop</h2>

<p>For loops have the following syntax:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>var count = 0
for (i &lt;- 0 to 10) count = count + i
count
</pre></td>
</tr></table>
</div>

<h2 id="functions">Functions</h2>

<p>Since scala is an object-oriented <em>functional</em> programming language, functions are
basically objects that you create with the keyword <code>def</code>. For example:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre>def sum(a: Int, b: Int): Int = a + b
sum(900,100)
</pre></td>
</tr></table>
</div>
<p>The <code>Int</code> after the colon is the return type. You can leave out specifying the
return type in most cases since scala can infer that by itself. Just like any
functional language, functions can be stored and passed around like objects.</p>

<p>If you don’t want your function to return a value (like <code>void</code>) in C, use <code>Unit</code>
as the return value:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre>def print(a: Int): Unit = println(a)
print(3)
</pre></td>
</tr></table>
</div>

<p>Like Ruby, the last statement in the body of a function is its return value.</p>

<h3 id="higher-order-functions">Higher-order functions</h3>

<p>Scala allows defining functios that take other functions as its arguments.
This can be done by specifying the argument types and return type of the function
as the data type of the variable that accepts this. For example:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre>def apply(f: Int =&gt; String, v: Int) = f(v)
</pre></td>
</tr></table>
</div>
<p>In the above code the <code>apply</code> function will accept a function <code>f</code> as an arguement
which accepts one <code>Int</code> and returns a <code>String</code>.</p>

<h3 id="functions-as-variables">Functions as variables</h3>

<p>Functions can be assigned to a <code>val</code> by specifying the prototype of the function:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre>val sum: (Int, Int) =&gt; Int = (a: Int, b: Int) =&gt; a + b
sum(3,6)
</pre></td>
</tr></table>
</div>

<p>Or even by a simple assignment using the <code>new</code> keyword:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
</pre></td>
  <td class="code"><pre>val verboseSum = new Function2[Int, Int, Int] {
    def apply(a: Int, b: Int): Int = a + b
}

verboseSum(3,6)
</pre></td>
</tr></table>
</div>

<p>In the assingnment we’ve used with <code>new Function2[-T1,-T2,+R]</code> constructor. This is a
<a href="http://www.scala-lang.org/api/2.9.1/scala/Function2.html">special scala trait</a> that can be used for
defining anonymous functions. <code>Function2</code> specifies that the this function will accept
parameters of type <code>T1</code> and <code>T2</code> and will return a type <code>R</code>.</p>

<h3 id="passing-blocks-to-method-calls">Passing blocks to method calls</h3>

<p>Passing blocks to functions (similar to Ruby <code>do..end</code> blocks) is done by specifying curly
braces with the method call. Example:</p>
<pre><code>Receive {
  // do something...
}
</code></pre>

<h2 id="classes">Classes</h2>

<p>Classes are defined using the <code>class</code> keyword. Using a default constructor, the class
can be defined like so:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>class User

val user1 = new User
</pre></td>
</tr></table>
</div>

<p>A constructor can be used by directly specifying the expected argument with the classname:</p>
<pre><code>class Point(x: Int, y: Int) {
    def move(dx: Int, dy: Int) {
        dx = x + 1
        dy = y + 1
    }
}

new point1 = Point(2,3)
point1.x
</code></pre>

<h3 id="singleton-classes">Singleton classes</h3>

<p>Singleton classes in scala are created using the <code>object</code> keyword. This is something
like a module in Ruby. You cannot instantiate objects of such classes. You can simply
access the functions by name instead of creating objects. The <code>main</code> function of a
program must be defined inside a singleton class by the name of the package.</p>

<h3 id="inheritance">Inheritance</h3>

<p>Inheritance is done using the <code>extends</code> keyword and the <code>with</code> keyword. You can use
<code>extends</code> only once when defining a class and <code>with</code> multiple times after that. <code>with</code>
is used for multiple inheritance.</p>

<h4 id="instantiating-base-class-with-certain-values">Instantiating base class with certain values</h4>

<h3 id="case-classes">Case classes</h3>

<p>Case classes are useful for modelling immutable data.</p>

<h4 id="defining-case-classes">Defining case classes</h4>

<p>Defined using the <code>case class</code> keyword. These classes do not require the <code>new</code> keyword
for instantiation because they have an implicit <code>apply</code> method defined internally. You
can use these classes like so:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>case class Book(isbn: String)

val frankenstein = Book(&quot;978-0486282114&quot;)
</pre></td>
</tr></table>
</div>
<p>All attributes of case classes are public and are immutable.</p>

<h2 id="pattern-matching">Pattern matching</h2>

<p>Pattern matching is a powerful tool in Scala for matching an input vs. a set of possible
outcomes. It similar in nature to other FP languages like OCaml.</p>

<p>At its simplest, it can be thought of as a switch-case statement in Java, but with more
power. A simple example would be:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
</pre></td>
  <td class="code"><pre>import scala.util.Random

val x: Int = Random.nextInt(10)

x match {
  case 0 =&gt; &quot;zero&quot;
  case 1 =&gt; &quot;one&quot;
  case 2 =&gt; &quot;two&quot;
  case _ =&gt; &quot;many&quot;
}
</pre></td>
</tr></table>
</div>

<h3 id="list-pattern-matching">List pattern matching</h3>

<h3 id="pattern-matching-anonymous-functions">Pattern matching anonymous functions</h3>

<p>Scala provides a way of pattern matching anonymous functions. These are basically blocks
containing the usual <code>case</code> statements but without the <code>match</code>.</p>

<h2 id="operators">Operators</h2>

<p>This warrants a new section because scala uses a lot of fancy operators for doing all sorts
of ‘magic’ things that can be confusing at first.</p>

<h2 id="eccentric-things">Eccentric things</h2>

<h3 id="in-code-todo-statements">In-code TODO statements</h3>

<p>Scala allows you to throw NotImplementedError using a simpler syntax where you can define
a value <code>???</code> to throw an exception:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>def ???: Nothing = throw new NotImplementedError

def answerToLifeAndEverything() = ???
</pre></td>
</tr></table>
</div>

<h3 id="option-types">Option types</h3>

<h3 id="importing-package-inside-classes">Importing package inside classes</h3>

<p>If you write some case classes (or anything for that matter) inside an <code>object</code>, you need to
declare <code>import ObjectName._</code> inside any class where you want to use members defined inside
that object. This is because the symbols get namespaced.</p>

<h1 id="distributed-algorithms-in-scala">Distributed algorithms in scala</h1>

<p>Professor Xavier’s lab has written a library called <a href="http://www.coord.c.titech.ac.jp/projects/scalaneko/api/neko/">scalaneko</a> that is useful
for prototyping and implementing distributed systems using scala. This assingnment
asks us write an algorithm that does a parallel traversal of a connected graph
of processes using scala.</p>

<h2 id="scalaneko-protips">Scalaneko protips</h2>

<p>The basic unit of concurrency is a processs. Each process can contain many protocols. Protocols
implement the actual algorithms of the system. Protocols and processes exchange information
through events. There are two types of events: signals and messages. Signals allows protocols
within the same process to notify each other. Messages are for protocol instances to communicate
across different processes. Therefore, only messages are transmitted through the network.</p>

<p>Working with scalaneko basically involves the following steps:</p>

<h3 id="initialize-scalaneko-environment">Initialize scalaneko environment</h3>

<p>Create a main object that provides the basic parameters for the execution, such as total
number of processes to create and their initializer. For example:</p>
<div class="language-scala highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
</pre></td>
  <td class="code"><pre>object HelloNeko
  extends Main(topology.Clique(2))(
    ProcessInitializer { p =&gt; 
      new Hello(p) 
    }
  )
</pre></td>
</tr></table>
</div>
<p>In the above code we initialize scalaneko with 2 processes and then state that each process
should be an instance of the <code>Hello</code> class.</p>

<h3 id="create-and-use-protocols">Create and use protocols</h3>

<p>You need to create protocols for the communication logic. This is done by extending a process class
like <code>Hello</code> in the above code using the <code>ActiveProtocol</code> class provided by scalaneko. Inside
the class you must define a method called <code>run</code> which will be called by ActiveProtocol inside
its own thread for running the protocol.</p>

<p>Messages are sent using the <code>ActiveProtocol.SEND</code> method and received via blocking calls to
<code>ActiveProtocol.RECEIVE</code> method. You should call <code>listenTo</code> to register messages of a
particular type before you can receive them.</p>

<p>You can also override the <code>ActiveProtocol.onReceive</code> method to process messages reactively.
Those that are not caught by <code>onReceive</code> are sent into a receive queue and must be handled using
<code>Receive</code>.</p>

<p>The <code>SEND</code> function in <code>ActiveProtocol</code> has the type:</p>
<pre><code>def SEND(m: Event): Unit 
</code></pre>
<p>The <code>Event</code> in the argument can be an object of type that inherits from <code>Unicastmessage</code> or
<code>Broadcastmessage</code>.</p>

<h3 id="process-initialization">Process initialization</h3>

<p>Process initialization is done using the <code>ProcessInitializer</code> class, whose sole role is
to create protocols of a process and combine them. For example:</p>
<pre><code>ProcessInitializer { p =&gt;
    val app  = new PingPong(p)
    val fifo = new FIFOChannel(p)
    app --&gt; fifo
}
</code></pre>

<p>In the above example, each process is initialized by executing the above code. The
code creates two protocols while registering them into the object p given as argument
(which represents the process being initialized). Then, the two protocols are connected
such that all SEND operations of protocol <code>app</code> are handed to protocol <code>fifo</code>. The send
operations of protocol fifo use the default target which is the network interface of
the process.</p>

<h3 id="messages-and-signals">Messages and signals</h3>

<p>Signals happen inside a process, and can go from one protocol to another, but never crosses
process boundaries. Represented by class <code>neko.Signal</code>. A message is an event that crosses
process boundaries, but is typically interpreted by the same protocol in the target process.
Represented by a subclass of <code>neko.Message</code>.</p>

<p>Messages can be multicast (<code>neko.MulticastMessage</code>), unicast (<code>neko.UnicastMessage</code>) or
a wrapper (<code>neko.Wrapper</code>) that wraps an existing message.</p>

<h3 id="message-sending-methoology">Message sending methoology</h3>

<p>The <code>SEND</code> and <code>DELIVER</code> functions are used for sending messages. Both of them work with
objects of type Event. Thugh they sound the same they have some important differences.</p>
<pre><code>         application
  |                      ^
  V                      |
+----------------------------+
| onSend        DELIVER(...) |
|                            | Reactive protocol
| SEND(...)        onReceive |
+----------------------------+
  |                      ^
  V                      |
          network
</code></pre>
<p>Having a look at Professor Xavier’s Tarry traversal codes, I think that SEND is more
useful for communicating from one process to another and DELIVER for communicating
to the App class that send the initiator message and stuff like that.</p>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="http://uclmr.github.io/stat-nlp-book-scala/05_tutorial/01_intro_to_scala_part1.html">Scala crash course.</a></li>
  <li><a href="http://docs.scala-lang.org/tutorials/tour/higher-order-functions.html.html">Higher-order functions.</a></li>
  <li><a href="http://www.scala-lang.org/api/2.9.1/scala/Function2.html">Scala Function2.</a></li>
  <li><a href="https://www.safaribooksonline.com/library/view/learning-scala/9781449368814/ch09.html">Objects and classes in scala.</a></li>
  <li><a href="https://stackoverflow.com/questions/41031166/scala-extends-vs-with">Extends vs with.</a></li>
  <li><a href="http://scala-lang.org/files/archive/spec/2.12/05-classes-and-objects.html">Classes and objects in scala official docs.</a></li>
  <li><a href="https://alvinalexander.com/scala/how-to-declare-constructor-parameters-extending-scala-class">Declare constructor parameters of extended scala class.</a></li>
  <li><a href="https://docs.scala-lang.org/tour/case-classes.html">Scala case classes</a></li>
  <li><a href="http://danielwestheide.com/blog/2012/12/12/the-neophytes-guide-to-scala-part-4-pattern-matching-anonymous-functions.html">Pattern matching anonymous functions.</a></li>
  <li><a href="https://github.com/ghik/opinionated-scala/wiki/Methods-and-operators">Magic in scala methods and operators.</a></li>
  <li><a href="http://www.coord.c.titech.ac.jp/projects/scalaneko/api/neko/">ScalaNeko API docs.</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Chang_and_Roberts_algorithm">Chang-Roberts algorithm.</a></li>
  <li><a href="http://danielwestheide.com/blog/2012/12/19/the-neophytes-guide-to-scala-part-5-the-option-type.html">Scala Option type.</a></li>
</ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/12/setup-japanese-environment-on-ubuntu-and-emacs/">Setup Japanese Environment on Ubuntu and Emacs</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>I’m currently living in Japan and learning Japanese in University. In order to make
learning easier I’m using the <a href="https://ankiweb.net">Anki</a> app. However, Ubuntu and 
emacs don’t come with easy Japanese functionality out of the box and in this post 
I will document the efforts I took to make this happen.</p>

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="#ubuntu-setup">Ubuntu setup</a></li>
  <li><a href="#emacs-setup">Emacs setup</a></li>
  <li><a href="#resources">Resources</a></li>
</ul>

<!-- markdown-toc end -->

<h1 id="ubuntu-setup">Ubuntu setup</h1>

<p>For ubuntu, the preferred Japanese input method is a Japanese keyboard called mozc.
Use the link in the resources below for this purpose.</p>

<p>Then, setup the following ENV variables in your .bashrc:</p>
<pre><code>export QT_IM_MODULE=fcitx
export GTK_IM_MODULE=fcitx
</code></pre>
<p>You can go the text entry setting and set the keyboard change button to ‘pause’,
which I did.</p>

<h1 id="debian-setup">Debian setup</h1>

<p>You can’t install mozc on Debian GUI so you should first install the <code>ibus-mozc</code> package
and then use the ibus GUI for selecting mozc.</p>

<h1 id="emacs-setup">Emacs setup</h1>

<p>You can then proceed to setup your emacs with the mozc keyboard. For this purpose,
you should first copy-paste the file <code>mozc.el</code> from the <a href="https://github.com/google/mozc/blob/master/src/unix/emacs/mozc.el">mozc sources</a>
into your .emacs.d/ folder and then paste the following into your <code>init.el</code> (after
loading the mozc.el file).</p>
<div class="language-elisp highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>(require 'mozc)
(setq default-input-method &quot;japanese-mozc&quot;)
(setq mozc-candidate-style 'overlay)
</pre></td>
</tr></table>
</div>
<p>Once this is done, install the <code>emacs-mozc-bin</code> package from the ubuntu sources
so that emacs can communicate with the mozc server.</p>

<p>You should now be able to change between Japanese and English keyboards using the
<code>C-\</code> command inside emacs. This does not change your system input.</p>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="https://moritzmolch.com/2287">Ubuntu setup instructions for mozc.</a></li>
  <li><a href="https://www.emacswiki.org/emacs/WritingJapanese">Writing Japanese in emacs</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/mozc#Mozc_for_Emacs">Archlinux mozc emacs.</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/10/distributed-lu-decomposition-using-scalapack-in-c/">Distributed LU Decomposition Using Scalapack in C++</a></h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


  <div class="entry-content"><p>ScaLAPACK is the distributed version of LAPACK. The interface of most functions is 
almost similar. However, not much documentation and example code is available for 
scalapack in C++, which is why I’m writing this blog post to document my learnings.
Hopefully this will be useful for others too.</p>

<p>This post is part of a larger post where I’ve implemented and benchmarked synchronous 
and asynchronous block LU deocomposition. That post can be found <a href="URL">here</a>. <a href="https://software.intel.com/en-us/mkl-developer-reference-c-p-getrf">This</a> intel resource is also helpful for this purpose.</p>

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="#scalapack-protips">Scalapack protips</a></li>
  <li><a href="#function-usage-protips">Function usage protips</a></li>
  <li><a href="#source-code">Source code</a></li>
  <li><a href="#resources">Resources</a></li>
</ul>

<!-- markdown-toc end -->

<h1 id="scalapack-protips">Scalapack protips</h1>

<p>There are certain terminologies that are pretty widely used in scalapack. They are as follows:</p>
<ul>
  <li>Scalapack docs assume that a matrix of <code>K</code> rows or columns is distributed over a process grid of dimensions p x q.</li>
  <li><code>LOCr</code> :: <code>LOCr(K)</code> denotes the number of elements of K that a process would receive if K were
distributed over the p processes of its process column.</li>
  <li><code>LOCc</code> :: <code>LOCc(K)</code> denotes the number of elements of K that a process would receive if K were 
distributed over the q processes of its process row.</li>
  <li>The values of <code>LOCc</code> and <code>LOCr</code> can be determined using a call to the <code>numroc</code> function.</li>
  <li><strong>IMPORTANT</strong> :: None of these functions have C interfaces the way there are for LAPACK via LAPACKE. 
Therefore, you must take care to pass all variables by address, not by value and store all your data 
in FORTRAN-style, i.e. column-major format not row-major.</li>
</ul>

<p>The <code>numroc</code> function is useful in almost every scalapack function. It computes the number of rows 
and columns of a distributed matrix ownded by the process (the return value). Here’s an explanation 
alongwith the prototype:</p>
<div class="language-cpp highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
</pre></td>
  <td class="code"><pre><span style="color:#0a8;font-weight:bold">int</span> numroc_(
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *n, <span style="color:#777">// (global) the number of rows/cols in dist matrix</span>
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *nb, <span style="color:#777">// (global) block size. size of blocks the distributed matrix is split into.</span>
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *iproc, <span style="color:#777">// (local input) coord of the process whose local array row is to be determined.</span>
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *srcproc, <span style="color:#777">// (global input) coord of the process that has the first row/col of distributed matrix.</span>
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *nprocs <span style="color:#777">// (global input) total no. of processes over which the matrix is distributed.</span>
);
</pre></td>
</tr></table>
</div>

<h2 id="errors">Errors</h2>

<p>Scalapack reports errors using the XERBLA error handler. Here’s some resources for this:</p>
<ul>
  <li><a href="http://www.netlib.org/scalapack/slug/node151.html#SECTION04751000000000000000">Invalid arguments and XERBLA.</a></li>
  <li><a href="http://www.netlib.org/scalapack/slug/node149.html#seccommonerrors">Common errors in calling ScaLAPACK routines.</a></li>
</ul>

<h1 id="function-usage-protips">Function usage protips</h1>

<p>As with other PBLAS or ScaLAPACK functions, this function expects the matrix to be already distributed over the BLACS process grid (and of course the BLACS process grid should be initialized).</p>

<p>The function in scalapack for LU decomposition is <code>pdgetrf_</code>. The C++ prototype of this function is
as follows:</p>
<div class="language-cpp highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">void</span> pdgetrf_(
    <span style="color:#0a8;font-weight:bold">int</span> *m,   <span style="color:#777">// (global) The number of rows in the distributed matrix sub(A)</span>
    <span style="color:#0a8;font-weight:bold">int</span> *n,   <span style="color:#777">// (global) The number of columns in the distributed matrix sub(A)</span>
    <span style="color:#777">// (local) Pointer into the local memory to an array of local size.</span>
    <span style="color:#777">// Contains the local pieces of the distributed matrix sub(A) to be factored.</span>
    <span style="color:#0a8;font-weight:bold">double</span> *a,
    <span style="color:#0a8;font-weight:bold">int</span> *ia,  <span style="color:#777">// (global) row index in the global matrix A indicating first row matrix sub(A)</span>
    <span style="color:#0a8;font-weight:bold">int</span> *ja,  <span style="color:#777">// (global) col index in the global matrix A indicating first col matrix sub(A)</span>
    <span style="color:#0a8;font-weight:bold">int</span> *desca, <span style="color:#777">// array descriptor of A</span>
    <span style="color:#0a8;font-weight:bold">int</span> *ipiv, <span style="color:#777">// contains the pivoting information. array of size</span>
    <span style="color:#0a8;font-weight:bold">int</span> *info <span style="color:#777">// information about execution.</span>
);
</pre></td>
</tr></table>
</div>

<p>In the above prototype, <code>m</code> signifies the number of rows of the submatrix, meaning
the matrix that is present in the current process. Similarly for <code>n</code> in case of cols.</p>

<p>A function <code>descinit_</code> can be used for initializing the descriptor array. Its prototype is as
follows:</p>
<div class="language-cpp highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">void</span> descinit_(<span style="color:#0a8;font-weight:bold">int</span> *desc, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *m,  <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *n, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *mb, 
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *nb, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *irsrc, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *icsrc, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *ictxt, 
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *lld, <span style="color:#0a8;font-weight:bold">int</span> *info);
</pre></td>
</tr></table>
</div>
<p>In the <code>descinit_</code>, the <code>MB</code> and <code>NB</code> parameters signify the size of the block into which the
matrix is divided. Not the size of the block that each process will receive. See the <code>sync_lu</code>
code for an <a href="https://github.com/v0dro/scratch/tree/master/c_shizzle/parallel/sync_lu">example</a> of block cyclic LU decomposition.</p>

<p>The <code>ipiv</code> array is not a synchronized data struture - it will be different for each process.
According to the docs, <code>ipiv(i)</code> is the global row local row i was swapped with. This array 
is tied to the distributed matrix A.</p>

<h2 id="storage-in-the-arrays">Storage in the arrays</h2>

<p>Each local array of a process should store a part of the global matrix. The global matrix is stored
in a block cyclic manner and scalapack reads each local array expecting it in a particular format.
It is important to be aware of this.</p>

<p>See <a href="http://netlib.org/scalapack/slug/node28.html">this</a> explanation on the scalapack site to get a complete understanding.</p>

<h1 id="source-code">Source code</h1>

<p>Here’s a full source implementing a simple LU decomposition using ScaLAPACK:</p>

<div class="language-cpp highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
<a href="#n14" name="n14">14</a>
<a href="#n15" name="n15">15</a>
<a href="#n16" name="n16">16</a>
<a href="#n17" name="n17">17</a>
<a href="#n18" name="n18">18</a>
<a href="#n19" name="n19">19</a>
<strong><a href="#n20" name="n20">20</a></strong>
<a href="#n21" name="n21">21</a>
<a href="#n22" name="n22">22</a>
<a href="#n23" name="n23">23</a>
<a href="#n24" name="n24">24</a>
<a href="#n25" name="n25">25</a>
<a href="#n26" name="n26">26</a>
<a href="#n27" name="n27">27</a>
<a href="#n28" name="n28">28</a>
<a href="#n29" name="n29">29</a>
<strong><a href="#n30" name="n30">30</a></strong>
<a href="#n31" name="n31">31</a>
<a href="#n32" name="n32">32</a>
<a href="#n33" name="n33">33</a>
<a href="#n34" name="n34">34</a>
<a href="#n35" name="n35">35</a>
<a href="#n36" name="n36">36</a>
<a href="#n37" name="n37">37</a>
<a href="#n38" name="n38">38</a>
<a href="#n39" name="n39">39</a>
<strong><a href="#n40" name="n40">40</a></strong>
<a href="#n41" name="n41">41</a>
<a href="#n42" name="n42">42</a>
<a href="#n43" name="n43">43</a>
<a href="#n44" name="n44">44</a>
<a href="#n45" name="n45">45</a>
<a href="#n46" name="n46">46</a>
<a href="#n47" name="n47">47</a>
<a href="#n48" name="n48">48</a>
<a href="#n49" name="n49">49</a>
<strong><a href="#n50" name="n50">50</a></strong>
<a href="#n51" name="n51">51</a>
<a href="#n52" name="n52">52</a>
<a href="#n53" name="n53">53</a>
<a href="#n54" name="n54">54</a>
<a href="#n55" name="n55">55</a>
<a href="#n56" name="n56">56</a>
<a href="#n57" name="n57">57</a>
<a href="#n58" name="n58">58</a>
<a href="#n59" name="n59">59</a>
<strong><a href="#n60" name="n60">60</a></strong>
<a href="#n61" name="n61">61</a>
<a href="#n62" name="n62">62</a>
<a href="#n63" name="n63">63</a>
<a href="#n64" name="n64">64</a>
<a href="#n65" name="n65">65</a>
<a href="#n66" name="n66">66</a>
<a href="#n67" name="n67">67</a>
<a href="#n68" name="n68">68</a>
<a href="#n69" name="n69">69</a>
<strong><a href="#n70" name="n70">70</a></strong>
<a href="#n71" name="n71">71</a>
<a href="#n72" name="n72">72</a>
<a href="#n73" name="n73">73</a>
<a href="#n74" name="n74">74</a>
<a href="#n75" name="n75">75</a>
<a href="#n76" name="n76">76</a>
<a href="#n77" name="n77">77</a>
<a href="#n78" name="n78">78</a>
<a href="#n79" name="n79">79</a>
<strong><a href="#n80" name="n80">80</a></strong>
<a href="#n81" name="n81">81</a>
<a href="#n82" name="n82">82</a>
<a href="#n83" name="n83">83</a>
<a href="#n84" name="n84">84</a>
<a href="#n85" name="n85">85</a>
<a href="#n86" name="n86">86</a>
<a href="#n87" name="n87">87</a>
<a href="#n88" name="n88">88</a>
<a href="#n89" name="n89">89</a>
<strong><a href="#n90" name="n90">90</a></strong>
<a href="#n91" name="n91">91</a>
<a href="#n92" name="n92">92</a>
<a href="#n93" name="n93">93</a>
<a href="#n94" name="n94">94</a>
<a href="#n95" name="n95">95</a>
<a href="#n96" name="n96">96</a>
<a href="#n97" name="n97">97</a>
<a href="#n98" name="n98">98</a>
<a href="#n99" name="n99">99</a>
<strong><a href="#n100" name="n100">100</a></strong>
<a href="#n101" name="n101">101</a>
<a href="#n102" name="n102">102</a>
<a href="#n103" name="n103">103</a>
<a href="#n104" name="n104">104</a>
<a href="#n105" name="n105">105</a>
<a href="#n106" name="n106">106</a>
</pre></td>
  <td class="code"><pre><span style="color:#777">// Implement simple distributed LU decomposition using scalapack.</span>
<span style="color:#777">// This code uses a simple block distribution of data. Not block cyclic.</span>
<span style="color:#777">// author: Sameer Deshmukh (@v0dro)</span>

<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&quot;mpi.h&quot;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;cstdlib&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;cmath&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;iostream&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;fstream&gt;</span>
<span style="color:#088;font-weight:bold">using</span> <span style="color:#080;font-weight:bold">namespace</span> std;

<span style="color:#088;font-weight:bold">extern</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">C</span><span style="color:#710">&quot;</span></span> {
  <span style="color:#777">/* Cblacs declarations */</span>
  <span style="color:#088;font-weight:bold">void</span> Cblacs_pinfo(<span style="color:#0a8;font-weight:bold">int</span>*, <span style="color:#0a8;font-weight:bold">int</span>*);
  <span style="color:#088;font-weight:bold">void</span> Cblacs_get(<span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#0a8;font-weight:bold">int</span>*);
  <span style="color:#088;font-weight:bold">void</span> Cblacs_gridinit(<span style="color:#0a8;font-weight:bold">int</span>*, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span>*, <span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#0a8;font-weight:bold">int</span>);
  <span style="color:#088;font-weight:bold">void</span> Cblacs_pcoord(<span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#0a8;font-weight:bold">int</span>*, <span style="color:#0a8;font-weight:bold">int</span>*);
  <span style="color:#088;font-weight:bold">void</span> Cblacs_gridexit(<span style="color:#0a8;font-weight:bold">int</span>);
  <span style="color:#088;font-weight:bold">void</span> Cblacs_barrier(<span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span>*);
 
  <span style="color:#0a8;font-weight:bold">int</span> numroc_(<span style="color:#0a8;font-weight:bold">int</span>*, <span style="color:#0a8;font-weight:bold">int</span>*, <span style="color:#0a8;font-weight:bold">int</span>*, <span style="color:#0a8;font-weight:bold">int</span>*, <span style="color:#0a8;font-weight:bold">int</span>*);

  <span style="color:#088;font-weight:bold">void</span> descinit_(<span style="color:#0a8;font-weight:bold">int</span> *desc, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *m,  <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *n, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *mb, 
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *nb, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *irsrc, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *icsrc, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *ictxt, 
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *lld, <span style="color:#0a8;font-weight:bold">int</span> *info);
  <span style="color:#088;font-weight:bold">void</span> pdgetrf_(
                <span style="color:#0a8;font-weight:bold">int</span> *m, <span style="color:#0a8;font-weight:bold">int</span> *n, <span style="color:#0a8;font-weight:bold">double</span> *a, <span style="color:#0a8;font-weight:bold">int</span> *ia, <span style="color:#0a8;font-weight:bold">int</span> *ja, <span style="color:#0a8;font-weight:bold">int</span> *desca,
                <span style="color:#0a8;font-weight:bold">int</span> *ipiv,<span style="color:#0a8;font-weight:bold">int</span> *info);
}

<span style="color:#088;font-weight:bold">void</span> print_arr(<span style="color:#0a8;font-weight:bold">double</span> *A, <span style="color:#0a8;font-weight:bold">int</span> size, <span style="color:#0a8;font-weight:bold">string</span> desc, ostream &amp;o)
{
  o &lt;&lt; desc &lt;&lt; endl;
  <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; size; ++i) {
    o &lt;&lt; A[i] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> </span><span style="color:#710">&quot;</span></span>;
  }
  o &lt;&lt; endl;
}

<span style="color:#088;font-weight:bold">void</span> print_files(<span style="color:#0a8;font-weight:bold">double</span> *A, <span style="color:#0a8;font-weight:bold">int</span> nrows, <span style="color:#0a8;font-weight:bold">int</span> ncols, <span style="color:#0a8;font-weight:bold">int</span> myrow, <span style="color:#0a8;font-weight:bold">int</span> mycol)
{
  <span style="color:#0a8;font-weight:bold">string</span> n = to_string(myrow*<span style="color:#00D">2</span> + mycol); 
  std::ofstream file;

  file.open(n + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">.txt</span><span style="color:#710">&quot;</span></span>);
  print_arr(A, nrows*ncols, n, file);
  file.close();
}

<span style="color:#0a8;font-weight:bold">int</span> main(<span style="color:#0a8;font-weight:bold">int</span> argc, <span style="color:#0a8;font-weight:bold">char</span> ** argv)
{
  <span style="color:#777">// MPI init</span>
  MPI_Init(&amp;argc, &amp;argv);
  <span style="color:#777">// end MPI Init</span>
  
  <span style="color:#777">// BLACS init</span>
  <span style="color:#0a8;font-weight:bold">int</span> BLACS_CONTEXT, proc_nrows, proc_ncols, myrow, mycol;
  <span style="color:#0a8;font-weight:bold">int</span> proc_id, num_procs;
  proc_nrows = <span style="color:#00D">2</span>; proc_ncols = <span style="color:#00D">2</span>;
  Cblacs_pinfo(&amp;proc_id, &amp;num_procs);
  Cblacs_get( -<span style="color:#00D">1</span>, <span style="color:#00D">0</span>, &amp;BLACS_CONTEXT );
  Cblacs_gridinit( &amp;BLACS_CONTEXT, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Row</span><span style="color:#710">&quot;</span></span>, proc_nrows, proc_ncols );
  Cblacs_pcoord(BLACS_CONTEXT, proc_id, &amp;myrow, &amp;mycol);
  <span style="color:#777">// end BLACS init</span>

  <span style="color:#777">// matrix properties</span>
  <span style="color:#777">// mat size, blk size, portion of block per process</span>
  <span style="color:#0a8;font-weight:bold">int</span> N = <span style="color:#00D">8</span>, nb = <span style="color:#00D">4</span>, process_block_size = <span style="color:#00D">2</span>;
  <span style="color:#0a8;font-weight:bold">int</span> num_blocks_per_process = N/process_block_size;
  <span style="color:#0a8;font-weight:bold">int</span> block_size_per_process_r = sqrt(num_blocks_per_process);
  <span style="color:#0a8;font-weight:bold">int</span> block_size_per_process_c = sqrt(num_blocks_per_process);
  <span style="color:#0a8;font-weight:bold">double</span>* a = (<span style="color:#0a8;font-weight:bold">double</span>*)malloc(<span style="color:#080;font-weight:bold">sizeof</span>(<span style="color:#0a8;font-weight:bold">double</span>)*nb*nb);
  <span style="color:#777">// generate matrix data</span>
  <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> j = <span style="color:#00D">0</span>; j &lt; nb; ++j) {
    <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; nb; ++i) {
      <span style="color:#0a8;font-weight:bold">int</span> index = i + j*nb;
      <span style="color:#0a8;font-weight:bold">int</span> row_i = myrow*nb + i;
      <span style="color:#0a8;font-weight:bold">int</span> col_j = mycol*nb + j;
      a[index] = row_i + col_j*N;
    }
    cout &lt;&lt; endl;
  }
  <span style="color:#777">// end matrix properties</span>

  <span style="color:#777">// create array descriptor</span>
  <span style="color:#0a8;font-weight:bold">int</span> desca[<span style="color:#00D">9</span>];
  <span style="color:#0a8;font-weight:bold">int</span> rsrc = <span style="color:#00D">0</span>, csrc = <span style="color:#00D">0</span>, info;
  descinit_(desca, &amp;N, &amp;N, &amp;nb, &amp;nb, &amp;rsrc, &amp;csrc, &amp;BLACS_CONTEXT, &amp;nb, &amp;info);
  <span style="color:#777">// end create array descriptor</span>

  Cblacs_barrier(BLACS_CONTEXT, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">All</span><span style="color:#710">&quot;</span></span>);

  <span style="color:#777">// LU decomposition</span>
  <span style="color:#0a8;font-weight:bold">int</span> ia = <span style="color:#00D">1</span>, ja = <span style="color:#00D">1</span>;
  <span style="color:#0a8;font-weight:bold">int</span> *ipiv = (<span style="color:#0a8;font-weight:bold">int</span>*)malloc(<span style="color:#080;font-weight:bold">sizeof</span>(<span style="color:#0a8;font-weight:bold">int</span>)*N);
  pdgetrf_(&amp;N, &amp;N, a, &amp;ia, &amp;ja, desca, ipiv, &amp;info);
  <span style="color:#777">// end LU decomposition</span>

  print_files(a, nb, nb, myrow, mycol);
  <span style="color:#080;font-weight:bold">if</span> (myrow == <span style="color:#00D">0</span> &amp;&amp; mycol == <span style="color:#00D">0</span>) {
    <span style="color:#080;font-weight:bold">for</span>(<span style="color:#0a8;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; N; ++i) {
      cout &lt;&lt; ipiv[i] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> </span><span style="color:#710">&quot;</span></span>;
    }
  }
  MPI_Finalize();
}
</pre></td>
</tr></table>
</div>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="https://software.intel.com/en-us/forums/intel-math-kernel-library/topic/288028">Intel Q and A on numroc</a></li>
  <li><a href="http://www.netlib.org/scalapack/explore-html/d4/d48/numroc_8f_source.html">Numroc fortran docs</a></li>
  <li><a href="https://software.intel.com/en-us/articles/using-cluster-mkl-pblasscalapack-fortran-routine-in-your-c-program">Using PBLAS/ScaLAPACK in your C code by intel (MKL specific)</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/06/07/notes-using-numpy/">Notes Using Numpy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/01/remote-file-editing-with-emacs/">Remote File Editing With Emacs.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/01/building-a-fast-matrix-multiplication-algorithm/">Building a FAST Matrix Multiplication Algorithm.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/04/20/emacs-org-mode-notes/">Emacs Org-mode Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/04/20/bash-scripting-to-automate-porting-to-other-machines/">Bash Scripting to Automate Porting to Other Machines</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/v0dro">@v0dro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'v0dro',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Sameer Deshmukh -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'v0dro';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
