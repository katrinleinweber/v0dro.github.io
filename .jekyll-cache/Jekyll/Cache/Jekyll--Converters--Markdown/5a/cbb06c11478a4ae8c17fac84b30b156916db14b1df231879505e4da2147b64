I"ùX<p>daru (Data Analysis in RUby) is a ruby gem for performing various data analysis and manipulation tasks in Ruby. It draws inspiration from pandas (python) and aims to be completely cross-compatible between all ruby implementations (MRI/JRuby etc.) yet leverage the individual benefits that each interpreter offers (for example the speed of C in MRI), while offering a simple and powerful API for data analysis, manipulation and visualization.</p>

<p>In this first article on daru, I will show you some aspects of how daru handles data and some operations that can be performed on a real-life data set.</p>

<h2 id="getting-started">Getting Started</h2>

<p>daru consists of two major data structures:</p>

<ul>
  <li><strong>Vector</strong> - A named one-dimensional array-like structure.</li>
  <li><strong>DataFrame</strong> - A named spreadsheet-like two-dimensional frame of data.</li>
</ul>

<p>A <em>Vector</em> can either be represented by a Ruby Array, NMatrix(MRI) or MDArray(JRuby) internally. This allows for fast data manipulation in native code. Users can change the underlying implementation at will (demonstrated in the <a href="/blog/2015/02/24/data-analysis-in-ruby-part-2/">next</a> blog post).</p>

<p>Both of these can be indexed by the <code>Daru::Index</code> or <code>Daru::MultiIndex</code> class, which allows us to reference and operate on data by name instead of the traditional numeric indexing, and also perform index-based manipulation, equality and plotting operations.</p>

<h4 id="vector">Vector</h4>

<p>The easiest way to create a vector is to simply pass the elements to a <code>Daru::Vector</code> constructor:</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
</pre></td>
  <td class="code"><pre>
v = <span style="color:#036;font-weight:bold">Daru</span>::<span style="color:#036;font-weight:bold">Vector</span>.new [<span style="color:#00D">23</span>,<span style="color:#00D">44</span>,<span style="color:#00D">66</span>,<span style="color:#00D">22</span>,<span style="color:#00D">11</span>]

<span style="color:#777"># This will create a Vector object v</span>

<span style="color:#777"># =&gt; </span>
<span style="color:#777">##&lt;Daru::Vector:78168790 @name = nil @size = 5 &gt;</span>
<span style="color:#777">#   ni</span>
<span style="color:#777"># 0 23</span>
<span style="color:#777"># 1 44</span>
<span style="color:#777"># 2 66</span>
<span style="color:#777"># 3 22</span>
<span style="color:#777"># 4 11</span>
</pre></td>
</tr></table>
</div>

<p>Since no name has been specified, the vector is named <code>nil</code>, and since no index has been specified either, a numeric index from 0..4 has been generated for the vector (leftmost column).</p>

<p>A better way to create vectors would be to specify the name and the indexes:</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
</pre></td>
  <td class="code"><pre>
sherlock = <span style="color:#036;font-weight:bold">Daru</span>::<span style="color:#036;font-weight:bold">Vector</span>.new [<span style="color:#00D">3</span>,<span style="color:#00D">2</span>,<span style="color:#00D">1</span>,<span style="color:#00D">1</span>,<span style="color:#00D">2</span>], <span style="color:#606">name</span>: <span style="color:#A60">:sherlock</span>, <span style="color:#606">index</span>: [<span style="color:#A60">:pipe</span>, <span style="color:#A60">:hat</span>, <span style="color:#A60">:violin</span>, <span style="color:#A60">:cloak</span>, <span style="color:#A60">:shoes</span>]

<span style="color:#777">#=&gt; </span>
<span style="color:#777">#&lt;Daru::Vector:78061610 @name = sherlock @size = 5 &gt;</span>
<span style="color:#777">#         sherlock</span>
<span style="color:#777">#    pipe       3</span>
<span style="color:#777">#     hat       2</span>
<span style="color:#777">#  violin       1</span>
<span style="color:#777">#   cloak       1</span>
<span style="color:#777">#   shoes       2</span>
</pre></td>
</tr></table>
</div>

<p>This way we can clearly see the quantity of each item possesed by Sherlock.</p>

<p>Data can be retrieved with the <code>[]</code> operator:</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre>
sherlock[<span style="color:#A60">:pipe</span>] <span style="color:#777">#=&gt; 3</span>
</pre></td>
</tr></table>
</div>

<h4 id="dataframe">DataFrame</h4>

<p>A basic DataFrame can be constructed by simply specifying the names of columns and their corresponding values in a hash:</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
</pre></td>
  <td class="code"><pre>
df = <span style="color:#036;font-weight:bold">Daru</span>::<span style="color:#036;font-weight:bold">DataFrame</span>.new({<span style="color:#606">a</span>: [<span style="color:#00D">1</span>,<span style="color:#00D">2</span>,<span style="color:#00D">3</span>,<span style="color:#00D">4</span>,<span style="color:#00D">5</span>], <span style="color:#606">b</span>: [<span style="color:#00D">10</span>,<span style="color:#00D">20</span>,<span style="color:#00D">30</span>,<span style="color:#00D">40</span>,<span style="color:#00D">50</span>]}, <span style="color:#606">name</span>: <span style="color:#A60">:normal</span>)

<span style="color:#777"># =&gt; </span>
<span style="color:#777">##&lt;Daru::DataFrame:77782370 @name = normal @size = 5&gt;</span>
<span style="color:#777">#            a      b </span>
<span style="color:#777">#     0      1     10 </span>
<span style="color:#777">#     1      2     20 </span>
<span style="color:#777">#     2      3     30 </span>
<span style="color:#777">#     3      4     40 </span>
<span style="color:#777">#     4      5     50 </span>
</pre></td>
</tr></table>
</div>

<p>You can also specify an index for the DataFrame alongwith the data and also specify the order in which the vectors should appear. Every vector in the DataFrame will carry the same index as the DataFrame once it has been created.</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
</pre></td>
  <td class="code"><pre>plus_one = <span style="color:#036;font-weight:bold">Daru</span>::<span style="color:#036;font-weight:bold">DataFrame</span>.new({<span style="color:#606">a</span>: [<span style="color:#00D">1</span>,<span style="color:#00D">2</span>,<span style="color:#00D">3</span>,<span style="color:#00D">4</span>,<span style="color:#00D">5</span>], <span style="color:#606">b</span>: [<span style="color:#00D">10</span>,<span style="color:#00D">20</span>,<span style="color:#00D">30</span>,<span style="color:#00D">40</span>,<span style="color:#00D">50</span>], <span style="color:#606">c</span>: [<span style="color:#00D">11</span>,<span style="color:#00D">22</span>,<span style="color:#00D">33</span>,<span style="color:#00D">44</span>,<span style="color:#00D">55</span>]}, <span style="color:#606">name</span>: <span style="color:#A60">:plus_one</span>, <span style="color:#606">index</span>: [<span style="color:#A60">:a</span>, <span style="color:#A60">:e</span>, <span style="color:#A60">:i</span>, <span style="color:#A60">:o</span>, <span style="color:#A60">:u</span>], <span style="color:#606">order</span>: [<span style="color:#A60">:c</span>, <span style="color:#A60">:a</span>, <span style="color:#A60">:b</span>])

<span style="color:#777"># =&gt; </span>
<span style="color:#777">##&lt;Daru::DataFrame:77605450 @name = plus_one @size = 5&gt;</span>
<span style="color:#777">#                c        a        b </span>
<span style="color:#777">#       a       11        1       10 </span>
<span style="color:#777">#       e       22        2       20 </span>
<span style="color:#777">#       i       33        3       30 </span>
<span style="color:#777">#       o       44        4       40 </span>
<span style="color:#777">#       u       55        5       50</span>
</pre></td>
</tr></table>
</div>

<p>daru will also add <code>nil</code> values to vectors that fall short of elements.</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
</pre></td>
  <td class="code"><pre>
missing =  <span style="color:#036;font-weight:bold">Daru</span>::<span style="color:#036;font-weight:bold">DataFrame</span>.new({<span style="color:#606">a</span>: [<span style="color:#00D">1</span>,<span style="color:#00D">2</span>,<span style="color:#00D">3</span>], <span style="color:#606">b</span>: [<span style="color:#00D">1</span>]}, <span style="color:#606">name</span>: <span style="color:#A60">:missing</span>)
<span style="color:#777">#=&gt; </span>
<span style="color:#777">#&lt;Daru::DataFrame:76043900 @name = missing @size = 3&gt;</span>
<span style="color:#777">#                    a          b </span>
<span style="color:#777">#         0          1          1 </span>
<span style="color:#777">#         1          2        nil </span>
<span style="color:#777">#         2          3        nil </span>
</pre></td>
</tr></table>
</div>

<p>Creating a DataFrame by specifying <code>Vector</code> objects in place of the values in the hash will correctly align the values according to the index of each vector. If a vector is missing an index present in another vector, that index will be added to the vector with the corresponding value set to <code>nil</code>.</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
<a href="#n14" name="n14">14</a>
</pre></td>
  <td class="code"><pre>
a = <span style="color:#036;font-weight:bold">Daru</span>::<span style="color:#036;font-weight:bold">Vector</span>.new [<span style="color:#00D">1</span>,<span style="color:#00D">2</span>,<span style="color:#00D">3</span>,<span style="color:#00D">4</span>,<span style="color:#00D">5</span>], <span style="color:#606">index</span>: [<span style="color:#A60">:a</span>, <span style="color:#A60">:e</span>, <span style="color:#A60">:i</span>, <span style="color:#A60">:o</span>, <span style="color:#A60">:u</span>]
b = <span style="color:#036;font-weight:bold">Daru</span>::<span style="color:#036;font-weight:bold">Vector</span>.new [<span style="color:#00D">43</span>,<span style="color:#00D">22</span>,<span style="color:#00D">13</span>], <span style="color:#606">index</span>: [<span style="color:#A60">:i</span>, <span style="color:#A60">:a</span>, <span style="color:#A60">:queen</span>]
on_steroids = <span style="color:#036;font-weight:bold">Daru</span>::<span style="color:#036;font-weight:bold">DataFrame</span>.new({<span style="color:#606">a</span>: a, <span style="color:#606">b</span>: b}, <span style="color:#606">name</span>: <span style="color:#A60">:on_steroids</span>)
<span style="color:#777">#=&gt; </span>
<span style="color:#777">#&lt;Daru::DataFrame:75841450 @name = on_steroids @size = 6&gt;</span>
<span style="color:#777">#                    a          b </span>
<span style="color:#777">#         a          1         22 </span>
<span style="color:#777">#         e          2        nil </span>
<span style="color:#777">#         i          3         43 </span>
<span style="color:#777">#         o          4        nil </span>
<span style="color:#777">#     queen        nil         13 </span>
<span style="color:#777">#         u          5        nil </span>

</pre></td>
</tr></table>
</div>

<p>A DataFrame can be constructed from multiple sources:</p>

<ul>
  <li>To construct by columns:
    <ul>
      <li><strong>Array of hashes</strong> - Where the key of each hash is the name of the column to which the value belongs.</li>
      <li><strong>Name-Array Hash</strong> - Where the hash key is set as the name of the vector and the data the corresponding value.</li>
      <li><strong>Name-Vector Hash</strong> - This is the most advanced way of creating a DataFrame. Treats the hash key as the name of the vector. Also aligns the data correctly based on index.</li>
      <li><strong>Array of Arrays</strong> - Each sub array will be considered as a Vector in the DataFrame.</li>
    </ul>
  </li>
  <li>To construct by rows using the <code>.rows</code> class method:
    <ul>
      <li><strong>Array of Arrays</strong> - This will treat each sub-array as an independent row.</li>
      <li><strong>Array of Vectors</strong> - Uses each Vector in the Array as a row of the DataFrame. Sets vector names according to the index of the Vector. Aligns vector elements by index.</li>
    </ul>
  </li>
</ul>

<h2 id="handling-data">Handling Data</h2>

<p>Now that you have a basic idea about representing data in daru, lets see some more features of daru by loading some real-life data from a CSV file and performing some operations on it.</p>

<p>For this purpose, we will use <a href="https://rubygems.org/gems/iruby">iruby</a> notebook, with which daru is compatible. iruby provides a great interface for visualizing and playing around with data. I highly recommend installing it for full utilization of this tutorial.</p>

<h4 id="loading-data-from-files">Loading Data From Files</h4>

<p>Let us load some data about the music listening history of one user from this subset of the <a href="https://github.com/v0dro/daru/blob/master/spec/fixtures/music_data.tsv">Last.fm data set</a>:</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
</pre></td>
  <td class="code"><pre>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">daru</span><span style="color:#710">'</span></span>

df = <span style="color:#036;font-weight:bold">Daru</span>::<span style="color:#036;font-weight:bold">DataFrame</span>.from_csv <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">music_data.tsv</span><span style="color:#710">'</span></span>, <span style="color:#606">col_sep</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#b0b">\t</span><span style="color:#710">&quot;</span></span>

</pre></td>
</tr></table>
</div>

<p>![/assets//images/daru1/create_music_df.png][Create a DataFrame from a TSV file.]</p>

<p>As you can see the <em>timestamp</em> field is in a somewhat non-Ruby format which is pretty difficult for the default Time class to understand, so we destructively map time zone information (IST in this case) and then change every <em>timestamp</em> string field into a Ruby <em>Time</em> object, so that operations on time can be easily performed.</p>

<p>Notice the syntax for referencing a particular vector. Use ârowâ for referencing any row.</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>
df.timestamp.recode! { |ts| ts += <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">+5:30</span><span style="color:#710">&quot;</span></span>}

</pre></td>
</tr></table>
</div>
<p>![/assets//images/daru1/dmap_vector.png][Destructively map a given vector.]</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
</pre></td>
  <td class="code"><pre>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">date</span><span style="color:#710">'</span></span>
df = df.recode(<span style="color:#A60">:row</span>) <span style="color:#080;font-weight:bold">do</span> |row|
  row[<span style="color:#A60">:timestamp</span>] = <span style="color:#036;font-weight:bold">DateTime</span>.strptime(row[<span style="color:#A60">:timestamp</span>], <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%Y-%m-%dT%H:%M:%SZ%z</span><span style="color:#710">'</span></span>).to_time
  row
<span style="color:#080;font-weight:bold">end</span>

</pre></td>
</tr></table>
</div>

<p>![/assets//images/daru1/df_row_map.png][Map all rows of a DataFrame.]</p>

<h4 id="basic-querying">Basic Querying</h4>

<p>A bunch of rows can be selected by specifying a range:</p>

<p><code>df.row[900..923]</code></p>

<p>![/assets//images/daru1/range_row_access.png][Accessing rows with a range]</p>

<h4 id="data-analysis">Data Analysis</h4>

<p>Lets dive deeper by actually trying to extract something useful from the data that we have. Say we want to know the name of the artist heard the maximum number of times. So we create a Vector which consists of the names of the artists as the index and the number of times the name appears in the data as the corresponding values:</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>
<span style="color:#777"># Group by artist name and call 'size' to see the number of rows each artist populates.</span>
artists = df.group_by(<span style="color:#A60">:artname</span>).size
</pre></td>
</tr></table>
</div>

<p>![/assets//images/daru1/get_max_artists.png][Create a vector of artist names vs number of times they appear.]</p>

<p>To get the maximum value out of these, use <code>#max_index</code>. This will return a Vector which has the max:</p>

<p><code>count.max_index</code></p>

<p>![/assets//images/daru1/artists_max.png][Obtain the most heard artist.]</p>

<h4 id="plotting">Plotting</h4>

<p>daru uses <a href="https://github.com/domitry/nyaplot">Nyaplot</a> for plotting, which is an optional dependency. Install nyaplot with <code>gem install nyaplot</code> and proceed.</p>

<p>To demonstrate, lets find the top ten artists heard by this user and plot the number of times their songs have been heard against their names in a bar graph. For this, use the <code>#sort</code> function, which will preserve the indexing of the vector.</p>

<div class="language-ruby highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
</pre></td>
  <td class="code"><pre>
top_ten = artists.sort(<span style="color:#606">ascending</span>: <span style="color:#069">false</span>)[<span style="color:#00D">0</span>..<span style="color:#00D">10</span>]

top_ten.plot <span style="color:#606">type</span>: <span style="color:#A60">:bar</span> <span style="color:#080;font-weight:bold">do</span> |plt| 
  plt.width <span style="color:#00D">1120</span> 
  plt.height <span style="color:#00D">500</span>
  plt.legend <span style="color:#069">true</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></td>
</tr></table>
</div>

<p>![/assets//images/daru1/plot_top_ten.png][Top ten artists plotted.]</p>

<p>More examples can be found in <a href="https://github.com/v0dro/daru#notebooks">the notebooks section of the daru README</a>.</p>

<h2 id="further-reading">Further Reading</h2>

<ul>
  <li>This was but a very small subset of the capabilities of daru. Go through the <a href="https://rubygems.org/gems/daru">documentation</a> for more methods of analysing your data with daru.</li>
  <li>You can find all the above examples implemented in <a href="http://nbviewer.ipython.org/github/v0dro/daru/blob/master/notebooks/intro_with_music_data_.ipynb">this notebook</a>.</li>
  <li>Contribute to daru on <a href="https://github.com/v0dro/daru">github</a>. Any contributions will be greatly appreciated!</li>
  <li>Many thanks to <a href="http://www.last.fm/">last.fm</a> for providing the data.</li>
  <li>Check out the <a href="/blog/2015/02/24/data-analysis-in-ruby-part-2/">next blog post in this series</a>, elaborating on the next release of daru.</li>
</ul>

:ET